---
title: "Sudan CMAM Dashboard"
runtime: shiny
output: 
  flexdashboard::flex_dashboard:
    orientation: rows
    vertical_layout: scroll
    social: menu
    source_code: https://github.com/katilingban/sudanCMAM
    theme: cerulean
---

```{r setup, include = FALSE}
if(!require(flexdashboard)) install.packages("flexdashboard")
if(!require(ggplot2)) install.packages("ggplot2")
if(!require(magrittr)) install.packages("magrittr")
if(!require(plotly)) install.packages("plotly")
if(!require(vistime)) install.packages("vistime")
if(!require(lubridate)) install.packages("lubridate")
if(!require(remotes)) install.packages("remotes")
if(!require(squeacr)) remotes::install_github("rapidsurveys/squeacr")

library(flexdashboard)
library(ggplot2)
library(magrittr)
library(plotly)
library(vistime)
library(lubridate)
library(remotes)
library(squeacr)

## Load UNICEF palette
unicef_blue      <- "#1CABE2"
unicef_darkgreen <- "#00833D"
unicef_green     <- "#80BD41"
unicef_yellow    <- "#FFC20E"
unicef_orange    <- "#F26A21"
unicef_red       <- "#E2231A"
unicef_darkred   <- "#961A49" 
unicef_purple    <- "#6A1E74"
unicef_warmgrey  <- "#D8D1C9"
unicef_coolgrey  <- "#777779"
unicef_black     <- "#2D2926"
unicef_darkblue  <- "#374EA2"

## UNICEF ggplot theme settings
unicef_theme <- theme_bw() +
  theme(plot.title = element_text(size = 16, colour = unicef_darkblue),
        plot.subtitle = element_text(size = 14, colour = unicef_blue),
        panel.border = element_rect(colour = unicef_darkblue,
                                    size = 0.5),
        panel.grid.major = element_line(linetype = 0),
        panel.grid.minor = element_line(linetype = 0),
        strip.background = element_rect(colour = unicef_darkblue,
                                        fill = unicef_darkblue),
        strip.text = element_text(colour = "white", size = 12),
        legend.key = element_rect(linetype = 0),
        legend.key.size = unit(x = 12, units = "points"),
        legend.spacing = unit(x = 4, units = "points"),
        legend.text = element_text(size =  12),
        axis.line.x = element_line(colour = unicef_darkblue, size = 0.5),
        axis.text.x = element_text(size = 10, colour = unicef_darkblue),
        axis.title.x = element_text(size = 12, colour = unicef_blue),
        axis.text.y = element_text(size = 10, colour = unicef_darkblue),
        axis.title.y = element_text(size = 12, colour = unicef_blue),
        axis.ticks = element_line(colour = unicef_darkblue, size = 0.25))

## Katilingban theme
katilingban_theme <- theme_bw() +
  theme(panel.border = element_rect(colour = "gray50",
                                    size = 0.5),
        panel.grid.major = element_line(linetype = 1,
                                        size = 0.1,
                                        colour = "gray90"),
        panel.grid.minor = element_line(linetype = 0),
        strip.background = element_rect(colour = "gray50",
                                        fill = "gray70"),
        strip.text = element_text(colour = "white", size = 12),
        legend.text = element_text(size = 12),
        legend.key = element_rect(linetype = 0),
        legend.key.size = unit(0.5, "cm"),
        legend.position = "top",
        axis.title = element_text(size = 12),
        axis.text.x = element_text(size = 10),
        axis.text.y = element_text(size = 10),
        axis.ticks = element_line(colour = "gray50", size = 0.5))
```

Sidebar {.sidebar}
================================================================================

```{r}
selectInput(inputId = "chosen_year",
            label = "Select year",
            choices = unique(monitoring$Year),
            selected = NULL)

selectInput(inputId = "state_name",
            label = "Select state",
            choices = unique(monitoring$State),
            selected = NULL)
```

#### Performance indicators

```{r}
checkboxInput(inputId = "standards",
              label = "Show Sphere standards",
              value = FALSE)
```

#### Responsiveness settings

```{r}
checkboxInput(inputId = "smooth",
              label = "Smooth the curve",
              value = FALSE)
```

Performance
================================================================================

Row
--------------------------------------------------------------------------------

### Performance Indicators at National Level

```{r}
x <- reactive({
  aggregate(cbind(Cured, Death, Default, `Non-Responder`) ~ Month + Year, 
            data = monitoring, FUN = sum) %>% 
    calculate_performance() %>%
    filter(Year == input$chosen_year) %>%
    mutate(`Cure Rate` = cured_prop * 100,
           `Defaulter Rate` = defaulter_prop * 100,
           `Death Rate` = dead_prop * 100,
           `Non-response Rate` = nr_prop * 100,
           Month = factor(x = Month, 
                          levels = c("Jan", "Feb", "Mar", "Apr", "May", "Jun", 
                                     "Jul", "Aug", "Sep", "Oct", "Nov", "Dec")))
})

output$performance <- renderPlotly({
  z <- x() %>% 
    ggplot(mapping = aes(x = Month, group = Year)) +
    geom_line(mapping = aes(y = `Cure Rate`), colour = "darkgreen") +
    geom_line(mapping = aes(y = `Death Rate`), colour = "black") +
    geom_line(mapping = aes(y = `Defaulter Rate`), colour = "red") +
    geom_line(mapping = aes(y = `Non-response Rate`), colour = "gray70") +
    scale_y_continuous(limits = c(0, 100),
                                  breaks = seq(from = 0, to = 100, by = 10)) +
    labs(title = input$chosen_year, y = "%")
  
  sphere_cure <- geom_hline(yintercept = 75, 
                            colour = "darkgreen", 
                            linetype = 2, size = 0.25)
  
  sphere_default <- geom_hline(yintercept = 15, 
                               colour = "red", 
                               linetype = 2, size = 0.25)
    
  sphere_dead <- geom_hline(yintercept = 10, 
                            colour = "black", 
                            linetype = 2, size = 0.25)
  
  ## Assemble plot
  if(input$standards) {
    z <- z + sphere_cure + sphere_default + sphere_dead + unicef_theme
  } else {
    z <- z + unicef_theme
  }
  
  ggplotly(p = z)
})

plotlyOutput(outputId = "performance")
```

Row
--------------------------------------------------------------------------------

### Performance Indicators at State Level

```{r, fig.height = 10}
xstate <- reactive({
  aggregate(cbind(Cured, Death, Default, `Non-Responder`) ~ State + Month + Year, 
               data = monitoring, FUN = sum) %>% 
    calculate_performance() %>%
    filter(Year == input$chosen_year) %>%
    mutate(`Cure Rate` = cured_prop * 100,
           `Defaulter Rate` = defaulter_prop * 100,
           `Death Rate` = dead_prop * 100,
           `Non-response Rate` = nr_prop * 100,
           Month = factor(x = Month, 
                          levels = c("Jan", "Feb", "Mar", "Apr", "May", "Jun", 
                                     "Jul", "Aug", "Sep", "Oct", "Nov", "Dec")))
})

output$state_performance <- renderPlotly({
  z <- xstate() %>%
    ggplot(mapping = aes(x = Month, group = State)) +
    geom_line(mapping = aes(y = `Cure Rate`), colour = "darkgreen") +
    geom_line(mapping = aes(y = `Death Rate`), colour = "black") +
    geom_line(mapping = aes(y = `Defaulter Rate`), colour = "red") +
    geom_line(mapping = aes(y = `Non-response Rate`), colour = "gray70") +
    scale_y_continuous(limits = c(0, 100),
                       breaks = seq(from = 0, to = 100, by = 10)) +
    labs(title = input$chosen_year, y = "%")
        
  sphere_cure <- geom_hline(yintercept = 75, 
                            colour = "darkgreen", 
                            linetype = 2, size = 0.25)
  
  sphere_default <- geom_hline(yintercept = 15, 
                               colour = "red", 
                               linetype = 2, size = 0.25)
    
  sphere_dead <- geom_hline(yintercept = 10, 
                            colour = "black", 
                            linetype = 2, size = 0.25)
  
  add_facets <- facet_wrap( ~ State, ncol = 6)

  if(input$standards) {
    z <- z + sphere_cure + sphere_default + sphere_dead + add_facets
  } else {
    z <- z + add_facets
  }

  z <- z + unicef_theme +
    theme(axis.text.x = element_text(size = 8, angle = 90),
          axis.text.y = element_text(size = 8))
  
  ggplotly(p = z)
})

plotlyOutput(outputId = "state_performance")
```

Row
--------------------------------------------------------------------------------

### Performance Indicators at Locality Level

```{r, fig.height = 10}
xlocality <- reactive({
  monitoring %>% 
    calculate_performance() %>%
    filter(Year == input$chosen_year,
           State == input$state_name) %>%
    mutate(`Cure Rate` = cured_prop * 100,
           `Defaulter Rate` = defaulter_prop * 100,
           `Death Rate` = dead_prop * 100,
           `Non-response Rate` = nr_prop * 100,
           Month = factor(x = Month, 
                          levels = c("Jan", "Feb", "Mar", "Apr", "May", "Jun", 
                                     "Jul", "Aug", "Sep", "Oct", "Nov", "Dec")))
})

output$locality_performance <- renderPlotly({
  z <- xlocality() %>%
    ggplot(mapping = aes(x = Month, group = Locality)) +
    geom_line(mapping = aes(y = `Cure Rate`), colour = "darkgreen") +
    geom_line(mapping = aes(y = `Death Rate`), colour = "black") +
    geom_line(mapping = aes(y = `Defaulter Rate`), colour = "red") +
    geom_line(mapping = aes(y = `Non-response Rate`), colour = "gray70") +
    scale_y_continuous(limits = c(0, 100),
                       breaks = seq(from = 0, to = 100, by = 10)) +
    labs(title = paste(input$state_name, input$chosen_year, sep = " "),
         y = "%")    
    
  sphere_cure <- geom_hline(yintercept = 75, 
                            colour = "darkgreen", 
                            linetype = 2, size = 0.25)
  
  sphere_default <- geom_hline(yintercept = 15, 
                               colour = "red", 
                               linetype = 2, size = 0.25)
    
  sphere_dead <- geom_hline(yintercept = 10, 
                            colour = "black", 
                            linetype = 2, size = 0.25)
  
  add_facets <- facet_wrap( ~ Locality, nrow = 3)

  if(input$standards) {
    z <- z + sphere_cure + sphere_default + sphere_dead + add_facets
  } else {
    z <- z + add_facets
  }
  
  z <- z +
    unicef_theme +
    theme(axis.text.x = element_text(size = 8, angle = 90),
          axis.text.y = element_text(size = 8))
  
  ggplotly(p = z)
})

plotlyOutput(outputId = "locality_performance")
```

Responsiveness
================================================================================

Row
--------------------------------------------------------------------------------

### Seasonal Calendar

```{r}
output$calendar <- renderPlotly({
  seasonal_calendar %>%
    filter(year(start) == input$chosen_year) %>%
    
    vistime()
})

plotlyOutput(outputId = "calendar")
```


Row
--------------------------------------------------------------------------------

### Admissions at National Level

```{r}
admissions_defaulters <- reactive({
  aggregate(cbind(`New Admissions`, Default) ~ Month + Year, 
            data = monitoring, FUN = sum) %>% 
    filter(Year == input$chosen_year) %>%
    mutate(Month = factor(x = Month, 
                          levels = c("Jan", "Feb", "Mar", "Apr", "May", "Jun", 
                                     "Jul", "Aug", "Sep", "Oct", "Nov", "Dec"))) %>%
    arrange(Month) %>%
    mutate(`Admissions (smoothed)` = smooth_m3a3(x = `New Admissions`),
           `Defaulters (smoothed)` = smooth_m3a3(x = Default))
})

output$admissions <- renderPlotly({
  z <- admissions_defaulters() %>%
    ggplot(mapping = aes(x = Month, group = Year)) +
    geom_line(mapping = aes(y = `New Admissions`), colour = "blue") +
    scale_y_continuous(limits = c(0, max(admissions_defaulters()[["New Admissions"]])),
                       breaks = seq(from = 0, 
                                    to = max(admissions_defaulters()[["New Admissions"]]),
                                    by = 5000)) +
    labs(title = input$chosen_year) +
    unicef_theme
  
  if(input$smooth) {
    z <- admissions_defaulters() %>%
      ggplot(mapping = aes(x = Month, group = Year)) +
      geom_line(mapping = aes(y = `New Admissions`), colour = "blue") +
      geom_line(mapping = aes(y = `Admissions (smoothed)`), colour = "gray90") +
      scale_y_continuous(limits = c(0, max(admissions_defaulters()[["New Admissions"]])),
                         breaks = seq(from = 0, 
                                      to = max(admissions_defaulters()[["New Admissions"]]),
                                      by = 5000)) +
      labs(title = input$chosen_year) +
      unicef_theme
  }
  
  ggplotly(p = z)
})

plotlyOutput(outputId = "admissions")
```

Row
--------------------------------------------------------------------------------

### Defaulters at National Level

```{r}
output$defaulters <- renderPlotly({
  z <- admissions_defaulters() %>%
    ggplot(mapping = aes(x = Month, group = Year)) +
    geom_line(mapping = aes(y = `Default`), colour = "red") +
    scale_y_continuous(limits = c(0, max(admissions_defaulters()[["Default"]])),
                       breaks = seq(from = 0, 
                                    to = max(admissions_defaulters()[["Default"]]),
                                    by = 500)) +
    labs(title = input$chosen_year) +
    unicef_theme
  
  if(input$smooth) {
    z <- admissions_defaulters() %>%
      ggplot(mapping = aes(x = Month, group = Year)) +
      geom_line(mapping = aes(y = `Default`), colour = "red") +
      geom_line(mapping = aes(y = `Defaulters (smoothed)`), colour = "gray90") +
      scale_y_continuous(limits = c(0, max(admissions_defaulters()[["Default"]])),
                         breaks = seq(from = 0, 
                                      to = max(admissions_defaulters()[["Default"]]),
                                      by = 500)) +
      labs(title = input$chosen_year) +
      unicef_theme    
  }
  
  ggplotly(p = z)
})

plotlyOutput(outputId = "defaulters")
```

Row
--------------------------------------------------------------------------------

### Admissions at State Level

```{r, fig.height = 8}
state_admissions_defaulters <- reactive({
  aggregate(cbind(`New Admissions`, Default) ~ State + Month + Year, 
            data = monitoring, FUN = sum) %>% 
    filter(Year == input$chosen_year) %>%
    mutate(Month = factor(x = Month, 
                          levels = c("Jan", "Feb", "Mar", "Apr", "May", "Jun", 
                                     "Jul", "Aug", "Sep", "Oct", "Nov", "Dec"))) %>%
    group_by(State) %>%
    arrange(Month, .by_group = TRUE) %>%
    mutate(`Admissions (smoothed)` = smooth_m3a3(x = `New Admissions`),
           `Defaulters (smoothed)` = smooth_m3a3(x = Default))
})

output$state_admissions <- renderPlotly({
  z <- state_admissions_defaulters() %>%
    ggplot(mapping = aes(x = Month, group = State)) +
    geom_line(mapping = aes(y = `New Admissions`), colour = "blue") +
    scale_y_continuous(limits = c(0, max(state_admissions_defaulters()[["New Admissions"]])),
                       breaks = seq(from = 0, 
                                    to = max(state_admissions_defaulters()[["New Admissions"]]),
                                    by = 1000)) +    
    labs(title = input$chosen_year) +
    facet_wrap( ~ State, ncol = 6) +
    unicef_theme +
    theme(axis.text.x = element_text(size = 8, angle = 90),
          axis.text.y = element_text(size = 8))  
  
  if(input$smooth) {
      z <- state_admissions_defaulters() %>%
        ggplot(mapping = aes(x = Month, group = State)) +
        geom_line(mapping = aes(y = `New Admissions`), colour = "blue") +
        geom_line(mapping = aes(y = `Admissions (smoothed)`), colour = "gray90") +
        scale_y_continuous(limits = c(0, max(state_admissions_defaulters()[["New Admissions"]])),
                           breaks = seq(from = 0, 
                                        to = max(state_admissions_defaulters()[["New Admissions"]]),
                                        by = 1000)) +    
        labs(title = input$chosen_year) +
        facet_wrap( ~ State, ncol = 6) +
        unicef_theme +
        theme(axis.text.x = element_text(size = 8, angle = 90),
              axis.text.y = element_text(size = 8))
  }
  
  ggplotly(p = z)
})

plotlyOutput(outputId = "state_admissions")
```

Row
--------------------------------------------------------------------------------

### Defaulters at State Level

```{r, fig.height = 8}
output$state_defaulters <- renderPlotly({
  z <- state_admissions_defaulters() %>%
    ggplot(mapping = aes(x = Month, group = State)) +
    geom_line(mapping = aes(y = Default), colour = "red") +
    scale_y_continuous(limits = c(0, max(state_admissions_defaulters()[["Default"]])),
                       breaks = seq(from = 0, 
                                    to = max(state_admissions_defaulters()[["Default"]]),
                                    by = 100)) +    
    labs(title = input$chosen_year) +
    facet_wrap( ~ State, ncol = 6) +
    unicef_theme +
    theme(axis.text.x = element_text(size = 8, angle = 90),
          axis.text.y = element_text(size = 8))  
  
  if(input$smooth) {
    z <- state_admissions_defaulters() %>%
    ggplot(mapping = aes(x = Month, group = State)) +
    geom_line(mapping = aes(y = Default), colour = "red") +
    geom_line(mapping = aes(y = `Defaulters (smoothed)`), colour = "gray90") +  
    scale_y_continuous(limits = c(0, max(state_admissions_defaulters()[["Default"]])),
                       breaks = seq(from = 0, 
                                    to = max(state_admissions_defaulters()[["Default"]]),
                                    by = 100)) +    
    labs(title = input$chosen_year) +
    facet_wrap( ~ State, ncol = 6) +
    unicef_theme +
    theme(axis.text.x = element_text(size = 8, angle = 90),
          axis.text.y = element_text(size = 8))  
  }
  
  ggplotly(p = z)
})

plotlyOutput(outputId = "state_defaulters")
```

Row
--------------------------------------------------------------------------------

### Admissions at Locality Level

```{r, fig.height = 8}
locality_admissions_defaulters <- reactive({
  monitoring %>% 
    filter(Year == input$chosen_year,
           State == input$state_name) %>%
    mutate(Month = factor(x = Month, 
                          levels = c("Jan", "Feb", "Mar", "Apr", "May", "Jun", 
                                     "Jul", "Aug", "Sep", "Oct", "Nov", "Dec"))) %>%
    group_by(Locality) %>%
    arrange(Month, .by_group = TRUE) %>%
    mutate(`Admissions (smoothed)` = smooth_m3a3(x = `New Admissions`),
           `Defaulters (smoothed)` = smooth_m3a3(x = Default))
})

output$locality_admissions <- renderPlotly({
  z <- locality_admissions_defaulters() %>%
    ggplot(mapping = aes(x = Month, group = State)) +
    geom_line(mapping = aes(y = `New Admissions`), colour = "blue") +
    labs(title = paste(input$state_name, input$chosen_year, sep = " ")) +
    facet_wrap( ~ Locality, nrow = 3) +
    unicef_theme +
    theme(axis.text.x = element_text(size = 8, angle = 90),
          axis.text.y = element_text(size = 8))  
  
  if(input$smooth) {
      z <- locality_admissions_defaulters() %>%
        ggplot(mapping = aes(x = Month, group = Locality)) +
        geom_line(mapping = aes(y = `New Admissions`), colour = "blue") +
        geom_line(mapping = aes(y = `Admissions (smoothed)`), colour = "gray90") +
        labs(title = paste(input$state_name, input$chosen_year, sep = " ")) +
        facet_wrap( ~ Locality, nrow = 3) +
        unicef_theme +
        theme(axis.text.x = element_text(size = 8, angle = 90),
              axis.text.y = element_text(size = 8))
  }
  
  ggplotly(p = z)
})

plotlyOutput(outputId = "locality_admissions")
```

Row
--------------------------------------------------------------------------------

### Defaulters at Locality Level

```{r, fig.height = 8}
output$locality_defaulters <- renderPlotly({
  z <- locality_admissions_defaulters() %>%
    ggplot(mapping = aes(x = Month, group = State)) +
    geom_line(mapping = aes(y = Default), colour = "red") +
    labs(title = paste(input$state_name, input$chosen_year, sep = " ")) +
    facet_wrap( ~ Locality, nrow = 3) +
    unicef_theme +
    theme(axis.text.x = element_text(size = 8, angle = 90),
          axis.text.y = element_text(size = 8))  
  
  if(input$smooth) {
      z <- locality_admissions_defaulters() %>%
        ggplot(mapping = aes(x = Month, group = Locality)) +
        geom_line(mapping = aes(y = `Default`), colour = "red") +
        geom_line(mapping = aes(y = `Defaulters (smoothed)`), colour = "gray90") +
        labs(title = paste(input$state_name, input$chosen_year, sep = " ")) +
        facet_wrap( ~ Locality, nrow = 3) +
        unicef_theme +
        theme(axis.text.x = element_text(size = 8, angle = 90),
              axis.text.y = element_text(size = 8))
  }
  
  ggplotly(p = z)
})

plotlyOutput(outputId = "locality_defaulters")
```

Case-finding
================================================================================

