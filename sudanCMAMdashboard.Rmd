---
title: "Sudan CMAM Dashboard"
runtime: shiny
output: 
  flexdashboard::flex_dashboard:
    orientation: rows
    vertical_layout: scroll
    social: menu
    source_code: https://github.com/katilingban/sudanCMAM
    theme: cerulean
---

```{r setup, include = FALSE}
if(!require(flexdashboard)) install.packages("flexdashboard")
if(!require(ggplot2)) install.packages("ggplot2")
if(!require(magrittr)) install.packages("magrittr")
if(!require(plotly)) install.packages("plotly")
if(!require(remotes)) install.packages("remotes")
if(!require(squeacr)) remotes::install_github("rapidsurveys/squeacr")

library(flexdashboard)
library(ggplot2)
library(magrittr)
library(plotly)
library(remotes)

load("data/sudan_cmam.rda")
```

Sidebar {.sidebar}
================================================================================

```{r}
selectInput(inputId = "chosen_year",
            label = "Select year",
            choices = unique(monitoring$Year),
            selected = NULL)

selectInput(inputId = "state_name",
            label = "Select state",
            choices = unique(monitoring$State),
            selected = NULL)
```

Performance
================================================================================

Row
--------------------------------------------------------------------------------

### National

```{r}
x <- reactive({
  aggregate(cbind(Cured, Death, Default, `Non-Responder`) ~ Month + Year, 
            data = monitoring, FUN = sum) %>% 
    calculate_performance() %>%
    filter(Year == input$chosen_year) %>%
    mutate(`Cure Rate` = cured_prop * 100,
           `Defaulter Rate` = defaulter_prop * 100,
           `Death Rate` = dead_prop * 100,
           `Non-response Rate` = nr_prop * 100,
           Month = factor(x = Month, 
                          levels = c("Jan", "Feb", "Mar", "Apr", "May", "Jun", 
                                     "Jul", "Aug", "Sep", "Oct", "Nov", "Dec")))
})

output$performance <- renderPlotly({
  z <- x() %>% 
    ggplot(mapping = aes(x = Month, group = Year)) +
    geom_line(mapping = aes(y = `Cure Rate`), colour = "darkgreen") +
    geom_line(mapping = aes(y = `Death Rate`), colour = "black") +
    geom_line(mapping = aes(y = `Defaulter Rate`), colour = "red") +
    geom_line(mapping = aes(y = `Non-response Rate`), colour = "gray70") +
    scale_y_continuous(limits = c(0, 100),
                       breaks = seq(from = 0, to = 100, by = 10)) +
    labs(y = "%") +
    theme_bw()  
  
  ggplotly(p = z)
})

plotlyOutput("performance")
```

Row
--------------------------------------------------------------------------------

### By state

```{r, fig.height = 10}
xstate <- reactive({
  aggregate(cbind(Cured, Death, Default, `Non-Responder`) ~ State + Month + Year, 
               data = monitoring, FUN = sum) %>% 
    calculate_performance() %>%
    filter(Year == input$chosen_year) %>%
    mutate(`Cure Rate` = cured_prop * 100,
           `Defaulter Rate` = defaulter_prop * 100,
           `Death Rate` = dead_prop * 100,
           `Non-response Rate` = nr_prop * 100,
           Month = factor(x = Month, 
                          levels = c("Jan", "Feb", "Mar", "Apr", "May", "Jun", 
                                     "Jul", "Aug", "Sep", "Oct", "Nov", "Dec")))
})

output$state_performance <- renderPlotly({
  z <- xstate() %>%
    ggplot(mapping = aes(x = Month, group = State)) +
    geom_line(mapping = aes(y = `Cure Rate`), colour = "darkgreen") +
    geom_line(mapping = aes(y = `Death Rate`), colour = "black") +
    geom_line(mapping = aes(y = `Defaulter Rate`), colour = "red") +
    geom_line(mapping = aes(y = `Non-response Rate`), colour = "gray70") +
    scale_y_continuous(limits = c(0, 100),
                       breaks = seq(from = 0, to = 100, by = 10)) +
    labs(y = "%") +
    facet_wrap( ~ State, ncol = 6) +
    theme_bw()  
  
  ggplotly(p = z)
})

plotlyOutput("state_performance")
```

Row
--------------------------------------------------------------------------------

### By locality

```{r, fig.height = 10}
xlocality <- reactive({
  monitoring %>% 
    calculate_performance() %>%
    filter(Year == input$chosen_year,
           State == input$state_name) %>%
    mutate(`Cure Rate` = cured_prop * 100,
           `Defaulter Rate` = defaulter_prop * 100,
           `Death Rate` = dead_prop * 100,
           `Non-response Rate` = nr_prop * 100,
           Month = factor(x = Month, 
                          levels = c("Jan", "Feb", "Mar", "Apr", "May", "Jun", 
                                     "Jul", "Aug", "Sep", "Oct", "Nov", "Dec")))
})

output$locality_performance <- renderPlotly({
  z <- xlocality() %>%
    ggplot(mapping = aes(x = Month, group = Locality)) +
    geom_line(mapping = aes(y = `Cure Rate`), colour = "darkgreen") +
    geom_line(mapping = aes(y = `Death Rate`), colour = "black") +
    geom_line(mapping = aes(y = `Defaulter Rate`), colour = "red") +
    geom_line(mapping = aes(y = `Non-response Rate`), colour = "gray70") +
    scale_y_continuous(limits = c(0, 100),
                       breaks = seq(from = 0, to = 100, by = 10)) +
    labs(y = "%") +
    facet_wrap( ~ Locality, ncol = 6) +
    theme_bw()  
  
  ggplotly(p = z)
})

plotlyOutput("locality_performance")
```

Responsiveness
================================================================================

Case-finding
================================================================================

