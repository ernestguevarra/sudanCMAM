---
title: "Sudan CMAM Dashboard"
runtime: shiny
output: 
  flexdashboard::flex_dashboard:
    orientation: rows
    vertical_layout: scroll
    social: menu
    source_code: https://github.com/katilingban/sudanCMAM
    theme: cerulean
---

```{r setup, include = FALSE}
if(!require(flexdashboard)) install.packages("flexdashboard")
if(!require(ggplot2)) install.packages("ggplot2")
if(!require(magrittr)) install.packages("magrittr")
if(!require(plotly)) install.packages("plotly")
if(!require(vistime)) install.packages("vistime")
if(!require(lubridate)) install.packages("lubridate")
if(!require(leaflet)) install.packages("leaflet")
if(!require(RColorBrewer)) install.packages("RColorBrewer")
if(!require(remotes)) install.packages("remotes")
if(!require(squeacr)) remotes::install_github(repo = "rapidsurveys/squeacr")
if(!require(sudan)) remotes::install_github(repo = "spatialworks/sudan")

library(flexdashboard)
library(ggplot2)
library(magrittr)
library(plotly)
library(vistime)
library(lubridate)
library(leaflet)
library(RColorBrewer)
library(remotes)
library(squeacr)
library(sudan)

## Create Mapbox base layer objects for leaflet mapping
mapbox.satellite <- "https://api.mapbox.com/styles/v1/mapbox/satellite-streets-v10/tiles/256/{z}/{x}/{y}?access_token=pk.eyJ1IjoiZXJuZXN0Z3VldmFycmEiLCJhIjoiejRRLXlZdyJ9.sqS1zi0rDH5CIzvcn9SXSg"
mapbox.street    <- "https://api.mapbox.com/styles/v1/mapbox/streets-v10/tiles/256/{z}/{x}/{y}?access_token=pk.eyJ1IjoiZXJuZXN0Z3VldmFycmEiLCJhIjoiejRRLXlZdyJ9.sqS1zi0rDH5CIzvcn9SXSg"
mapbox.dark      <- "https://api.mapbox.com/styles/v1/mapbox/dark-v9/tiles/256/{z}/{x}/{y}?access_token=pk.eyJ1IjoiZXJuZXN0Z3VldmFycmEiLCJhIjoiejRRLXlZdyJ9.sqS1zi0rDH5CIzvcn9SXSg"
mapbox.light     <- "https://api.mapbox.com/styles/v1/mapbox/light-v9/tiles/256/{z}/{x}/{y}?access_token=pk.eyJ1IjoiZXJuZXN0Z3VldmFycmEiLCJhIjoiejRRLXlZdyJ9.sqS1zi0rDH5CIzvcn9SXSg"
mapbox.moonlight <- "https://api.mapbox.com/styles/v1/ernestguevarra/cj3nban30001z2rpahc10c9ef/tiles/256/{z}/{x}/{y}?access_token=pk.eyJ1IjoiZXJuZXN0Z3VldmFycmEiLCJhIjoiejRRLXlZdyJ9.sqS1zi0rDH5CIzvcn9SXSg"
mapbox.northstar <- "https://api.mapbox.com/styles/v1/ernestguevarra/cj4ke832y4sng2spe2ds4fs55/tiles/256/{z}/{x}/{y}?access_token=pk.eyJ1IjoiZXJuZXN0Z3VldmFycmEiLCJhIjoiejRRLXlZdyJ9.sqS1zi0rDH5CIzvcn9SXSg"
mapbox.standard  <- "https://api.mapbox.com/styles/v1/ernestguevarra/cj5di36jn0gxg2rphjn3yetpt/tiles/256/{z}/{x}/{y}?access_token=pk.eyJ1IjoiZXJuZXN0Z3VldmFycmEiLCJhIjoiejRRLXlZdyJ9.sqS1zi0rDH5CIzvcn9SXSg"
mapbox.decimal   <- "https://api.mapbox.com/styles/v1/ernestguevarra/cj5ms1akt3pbi2smtcewsex9m/tiles/256/{z}/{x}/{y}?access_token=pk.eyJ1IjoiZXJuZXN0Z3VldmFycmEiLCJhIjoiejRRLXlZdyJ9.sqS1zi0rDH5CIzvcn9SXSg"
mapbox.terminal  <- "https://api.mapbox.com/styles/v1/ernestguevarra/cj6g0tzbd30kc2sph2wyh666m/tiles/256/{z}/{x}/{y}?access_token=pk.eyJ1IjoiZXJuZXN0Z3VldmFycmEiLCJhIjoiejRRLXlZdyJ9.sqS1zi0rDH5CIzvcn9SXSg"
mapbox.leshine  <- "https://api.mapbox.com/styles/v1/ernestguevarra/cjdlr8pvl0xiv2sqvq1evk1pl/tiles/256/{z}/{x}/{y}?access_token=pk.eyJ1IjoiZXJuZXN0Z3VldmFycmEiLCJhIjoiejRRLXlZdyJ9.sqS1zi0rDH5CIzvcn9SXSg"

## Load UNICEF palette
unicef_blue      <- "#1CABE2"
unicef_darkgreen <- "#00833D"
unicef_green     <- "#80BD41"
unicef_yellow    <- "#FFC20E"
unicef_orange    <- "#F26A21"
unicef_red       <- "#E2231A"
unicef_darkred   <- "#961A49" 
unicef_purple    <- "#6A1E74"
unicef_warmgrey  <- "#D8D1C9"
unicef_coolgrey  <- "#777779"
unicef_black     <- "#2D2926"
unicef_darkblue  <- "#374EA2"

## UNICEF ggplot theme settings
unicef_theme <- theme_bw() +
  theme(plot.title = element_text(size = 16, colour = unicef_darkblue),
        plot.subtitle = element_text(size = 14, colour = unicef_blue),
        panel.border = element_rect(colour = unicef_darkblue,
                                    size = 0.5),
        panel.grid.major = element_line(linetype = 0),
        panel.grid.minor = element_line(linetype = 0),
        strip.background = element_rect(colour = unicef_darkblue,
                                        fill = unicef_darkblue),
        strip.text = element_text(colour = "white", size = 12),
        legend.key = element_rect(linetype = 0),
        legend.key.size = unit(x = 12, units = "points"),
        legend.spacing = unit(x = 4, units = "points"),
        legend.text = element_text(size =  12),
        legend.position = "top",
        axis.line.x = element_line(colour = unicef_darkblue, size = 0.5),
        axis.text.x = element_text(size = 10, colour = unicef_darkblue),
        axis.title.x = element_text(size = 12, colour = unicef_blue),
        axis.text.y = element_text(size = 10, colour = unicef_darkblue),
        axis.title.y = element_text(size = 12, colour = unicef_blue),
        axis.ticks = element_line(colour = unicef_darkblue, size = 0.25))

## Katilingban theme
katilingban_theme <- theme_bw() +
  theme(panel.border = element_rect(colour = "gray50",
                                    size = 0.5),
        panel.grid.major = element_line(linetype = 1,
                                        size = 0.1,
                                        colour = "gray90"),
        panel.grid.minor = element_line(linetype = 0),
        strip.background = element_rect(colour = "gray50",
                                        fill = "gray70"),
        strip.text = element_text(colour = "white", size = 12),
        legend.text = element_text(size = 12),
        legend.key = element_rect(linetype = 0),
        legend.key.size = unit(0.5, "cm"),
        legend.position = "top",
        axis.title = element_text(size = 12),
        axis.text.x = element_text(size = 10),
        axis.text.y = element_text(size = 10),
        axis.ticks = element_line(colour = "gray50", size = 0.5))

legend.format <- function (prefix = "", 
                           suffix = "", 
                           between = " &ndash; ", 
                           digits = 3, 
                           big.mark = ",", 
                           transform = identity) {
  formatNum <- function(x) {
    format(round(transform(x), digits), trim = TRUE, 
           scientific = FALSE, big.mark = big.mark)
  }
    function(type, ...) {
        switch(type, numeric = (function(cuts) {
            paste0(prefix, formatNum(cuts), suffix)
        })(...), bin = (function(cuts) {
            n = length(cuts)
            paste0(prefix, formatNum(cuts[-n]), between, formatNum(cuts[-1]), 
                suffix)
        })(...), quantile = (function(cuts, p) {
            n = length(cuts)
            p = paste0(round(p * 100), "%")
            cuts = paste0(formatNum(cuts[-n]), between, formatNum(cuts[-1]), suffix)
        })(...), factor = (function(cuts) {
            paste0(prefix, as.character(transform(cuts)), suffix)
        })(...))
    }
}
```

Sidebar {.sidebar}
================================================================================

```{r}
selectInput(inputId = "state_name",
            label = "Select state",
            choices = unique(monitoring$State),
            selected = NULL)

output$select_locality <- renderUI({
  selectInput(inputId = "locality_name",
              label = "Select locality",
              choices = monitoring$Locality[monitoring$State == input$state_name],
              selected = monitoring$Locality[monitoring$State == input$state_name][1])
})

uiOutput("select_locality")

selectInput(inputId = "chosen_year",
            label = "Select year",
            choices = unique(monitoring$Year),
            selected = NULL)

hr()
br()
```

#### Spatial settings

```{r}
selectInput(inputId = "chosen_month",
            label = "Select month",
            choices = c("January" = "Jan",
                        "February" = "Feb",
                        "March" = "Mar",
                        "April" = "Apr",
                        "May" = "May",
                        "June" = "Jun",
                        "July" = "Jul",
                        "August" = "Aug",
                        "September" = "Sep",
                        "October" = "Oct",
                        "November" = "Nov",
                        "December" = "Dec"),
            selected = NULL)

selectInput(inputId = "indicator",
            label = "Choose indicator to map",
            choices = c("Responsiveness: Cure rate" = "Cure Rate",
                        "Responsiveness: Defaulter rate" = "Defaulter Rate",
                        "Responsiveness: Death rate" = "Death Rate",
                        "Responsiveness: Non-response rate" = "Non-response Rate"),
            selected = NULL)

selectInput(inputId = "map_tiles",
            label = "Choose map background",
            choices = c("Terminal" = "mapbox.terminal",
                        "Le Shine" = "mapbox.leshine",
                        "Satellite" = "mapbox.satellite",
                        "Street" = "mapbox.street",
                        "Dark" = "mapbox.dark",
                        "Light" = "mapbox.light",
                        "Moonlight" = "mapbox.moonlight",
                        "Northstar" = "mapbox.northstar",
                        "Standard" = "mapbox.standard",
                        "Decmial" = "mapbox.decimal"),
            selected = "map.terminal")

hr()
br()
```

#### Performance settings

```{r}
checkboxInput(inputId = "standards",
              label = "Show Sphere standards",
              value = FALSE)

hr()
br()
```

#### Responsiveness settings

```{r}
checkboxInput(inputId = "smooth",
              label = "Smooth line",
              value = FALSE)

checkboxInput(inputId = "showCalendar",
              label = "Show seasonal calendar",
              value = FALSE)

selectInput(inputId = "scales",
            label = "Scaling for plots",
            choices = c("Free" = "free_y",
                        "Fixed" = "fixed"),
            selected = "free_y")
```

Performance
================================================================================

Row
--------------------------------------------------------------------------------

### Cure Rate {.value-box}

```{r}
renderValueBox({
  yearTotal <- aggregate(cbind(Cured, Death, Default, `Non-Responder`) ~ Year, 
            data = monitoring, FUN = sum) %>% 
    calculate_performance() %>%
    filter(Year == input$chosen_year) %>%
    mutate(`Cure Rate` = cured_prop * 100,
           `Defaulter Rate` = defaulter_prop * 100,
           `Death Rate` = dead_prop * 100,
           `Non-response Rate` = nr_prop * 100)
  
  valueBox(
    value = paste(round(yearTotal$`Cure Rate`, digits = 2), "%", sep = ""),
    caption = paste("Cure Rate - Year", input$chosen_year, sep = " "),
    icon = if( yearTotal$`Cure Rate` <= 75) "fa-thumbs-down" else "fa-thumbs-up",
    color = if (yearTotal$`Cure Rate` <= 75) "danger" else "success"
  )
})
```

### Defaulter Rate {.value-box}

```{r}
renderValueBox({
  yearTotal <- aggregate(cbind(Cured, Death, Default, `Non-Responder`) ~ Year, 
            data = monitoring, FUN = sum) %>% 
    calculate_performance() %>%
    filter(Year == input$chosen_year) %>%
    mutate(`Cure Rate` = cured_prop * 100,
           `Defaulter Rate` = defaulter_prop * 100,
           `Death Rate` = dead_prop * 100,
           `Non-response Rate` = nr_prop * 100)
  
  valueBox(
    value = paste(round(yearTotal$`Defaulter Rate`, digits = 2), "%", sep = ""),
    caption = paste("Defaulter Rate - Year", input$chosen_year, sep = " "),
    icon = if( yearTotal$`Cure Rate` <= 75) "fa-thumbs-down" else "fa-thumbs-up",
    color = if (yearTotal$`Defaulter Rate` >= 15) "danger" else "success"
  )
})
```

### Death Rate {.value-box}

```{r}
renderValueBox({
  yearTotal <- aggregate(cbind(Cured, Death, Default, `Non-Responder`) ~ Year, 
            data = monitoring, FUN = sum) %>% 
    calculate_performance() %>%
    filter(Year == input$chosen_year) %>%
    mutate(`Cure Rate` = cured_prop * 100,
           `Defaulter Rate` = defaulter_prop * 100,
           `Death Rate` = dead_prop * 100,
           `Non-response Rate` = nr_prop * 100)
  
  valueBox(
    value = paste(round(yearTotal$`Death Rate`, digits = 2), "%", sep = ""),
    caption = paste("Death Rate - Year", input$chosen_year, sep = " "),
    icon = if( yearTotal$`Cure Rate` <= 75) "fa-thumbs-down" else "fa-thumbs-up",
    color = if (yearTotal$`Death Rate` >= 10) "danger" else "success"
  )
})
```

### Non-response Rate {.value-box}

```{r}
renderValueBox({
  yearTotal <- aggregate(cbind(Cured, Death, Default, `Non-Responder`) ~ Year, 
            data = monitoring, FUN = sum) %>% 
    calculate_performance() %>%
    filter(Year == input$chosen_year) %>%
    mutate(`Cure Rate` = cured_prop * 100,
           `Defaulter Rate` = defaulter_prop * 100,
           `Death Rate` = dead_prop * 100,
           `Non-response Rate` = nr_prop * 100)
  
  valueBox(
    value = paste(round(yearTotal$`Non-response Rate`, digits = 2), "%", sep = ""),
    caption = paste("Non-response Rate - Year", input$chosen_year, sep = " "),
    icon = if( yearTotal$`Cure Rate` <= 75) "fa-thumbs-down" else "fa-thumbs-up",
    color = if (yearTotal$`Non-response Rate` >= 5) "danger" else "success"
  )
})
```

Row {.tabset .tabset-fade}
--------------------------------------------------------------------------------

### National

```{r, fig.height = 5}
xOverall <- reactive({
  aggregate(cbind(Cured, Death, Default, `Non-Responder`) ~ Month + Year, 
            data = monitoring, FUN = sum) %>% 
    calculate_performance() %>%
    mutate(`Cure Rate` = cured_prop * 100,
           `Defaulter Rate` = defaulter_prop * 100,
           `Death Rate` = dead_prop * 100,
           `Non-response Rate` = nr_prop * 100,
           MonthYear = paste(Month, Year, sep = " "),
           MonthYear = factor(x = MonthYear, 
                              levels = c(paste(c("Jan", "Feb", "Mar", "Apr", 
                                                 "May", "Jun", "Jul", "Aug", 
                                                 "Sep", "Oct", "Nov", "Dec"), "2016"),
                                         paste(c("Jan", "Feb", "Mar", "Apr", 
                                                 "May", "Jun", "Jul", "Aug", 
                                                 "Sep", "Oct", "Nov", "Dec"), "2017"),
                                         paste(c("Jan", "Feb", "Mar", "Apr", 
                                                 "May", "Jun", "Jul", "Aug", 
                                                 "Sep", "Oct", "Nov", "Dec"), "2018"),
                                         paste(c("Jan", "Feb", "Mar", "Apr", 
                                                 "May", "Jun", "Jul", "Aug", 
                                                 "Sep", "Oct", "Nov", "Dec"), "2019"))))
})

output$performanceOverall <- renderPlotly({
  z <- xOverall() %>% 
    ggplot(mapping = aes(x = MonthYear, group = 1)) +
    geom_line(mapping = aes(y = `Cure Rate`, colour = "Cure Rate"), size = 1) +
    geom_line(mapping = aes(y = `Death Rate`, colour = "Death Rate"), size = 1) +
    geom_line(mapping = aes(y = `Defaulter Rate`, colour = "Defaulter Rate"), size = 1) +
    geom_line(mapping = aes(y = `Non-response Rate`, colour = "Non-response Rate"), 
              alpha = 0.5, size = 1) +
    scale_colour_manual(name = "",
                        values = c("Cure Rate" = "darkgreen", 
                                   "Death Rate" = "black", 
                                   "Defaulter Rate" = "red", 
                                   "Non-response Rate" = "gray50")) +
    scale_y_continuous(limits = c(0, 100),
                                  breaks = seq(from = 0, to = 100, by = 10)) +
    labs(title = "Performance over time - 2016 to 2019", y = "%", x = "")
  
  sphere_cure <- geom_hline(yintercept = 75, 
                            colour = "darkgreen", 
                            linetype = 2, size = 0.25)
  
  sphere_default <- geom_hline(yintercept = 15, 
                               colour = "red", 
                               linetype = 2, size = 0.25)
    
  sphere_dead <- geom_hline(yintercept = 10, 
                            colour = "black", 
                            linetype = 2, size = 0.25)
  
  ## Assemble plot
  if(input$standards) {
    z <- z + sphere_cure + sphere_default + sphere_dead + 
      unicef_theme +
      theme(axis.text.x = element_text(size = 8, angle = 90),
            axis.text.y = element_text(size = 8))
  } else {
    z <- z + 
      unicef_theme +
      theme(axis.text.x = element_text(size = 8, angle = 90),
            axis.text.y = element_text(size = 8))
  }
  
  ggplotly(p = z)
})

plotlyOutput(outputId = "performanceOverall")
```

### State

```{r, fig.height = 5}
xStateOverall <- reactive({
  aggregate(cbind(Cured, Death, Default, `Non-Responder`) ~ State + Month + Year, 
            data = monitoring, FUN = sum) %>% 
    calculate_performance() %>%
    filter(State == input$state_name) %>%
    mutate(`Cure Rate` = cured_prop * 100,
           `Defaulter Rate` = defaulter_prop * 100,
           `Death Rate` = dead_prop * 100,
           `Non-response Rate` = nr_prop * 100,
           MonthYear = paste(Month, Year, sep = " "),
           MonthYear = factor(x = MonthYear, 
                              levels = c(paste(c("Jan", "Feb", "Mar", "Apr", 
                                                 "May", "Jun", "Jul", "Aug", 
                                                 "Sep", "Oct", "Nov", "Dec"), "2016"),
                                         paste(c("Jan", "Feb", "Mar", "Apr", 
                                                 "May", "Jun", "Jul", "Aug", 
                                                 "Sep", "Oct", "Nov", "Dec"), "2017"),
                                         paste(c("Jan", "Feb", "Mar", "Apr", 
                                                 "May", "Jun", "Jul", "Aug", 
                                                 "Sep", "Oct", "Nov", "Dec"), "2018"),
                                         paste(c("Jan", "Feb", "Mar", "Apr", 
                                                 "May", "Jun", "Jul", "Aug", 
                                                 "Sep", "Oct", "Nov", "Dec"), "2019"))))
})

output$performanceStateOverall <- renderPlotly({
  z <- xStateOverall() %>% 
    ggplot(mapping = aes(x = MonthYear, group = State)) +
    geom_line(mapping = aes(y = `Cure Rate`, colour = "Cure Rate"), size = 1) +
    geom_line(mapping = aes(y = `Death Rate`, colour = "Death Rate"), size = 1) +
    geom_line(mapping = aes(y = `Defaulter Rate`, colour = "Defaulter Rate"), size = 1) +
    geom_line(mapping = aes(y = `Non-response Rate`, colour = "Non-response Rate"),
              alpha = 0.5, size = 1) +
    scale_colour_manual(name = "",
                        values = c("Cure Rate" = "darkgreen", 
                                   "Death Rate" = "black", 
                                   "Defaulter Rate" = "red", 
                                   "Non-response Rate" = "gray50")) +
    scale_y_continuous(limits = c(0, 100),
                                  breaks = seq(from = 0, to = 100, by = 10)) +
    labs(title = paste("Performance over time - 2016 to 2019 - ", 
                       input$state_name, " State", sep = ""),
         y = "%", x = "")
  
  sphere_cure <- geom_hline(yintercept = 75, 
                            colour = "darkgreen", 
                            linetype = 2, size = 0.25)
  
  sphere_default <- geom_hline(yintercept = 15, 
                               colour = "red", 
                               linetype = 2, size = 0.25)
    
  sphere_dead <- geom_hline(yintercept = 10, 
                            colour = "black", 
                            linetype = 2, size = 0.25)
  
  ## Assemble plot
  if(input$standards) {
    z <- z + sphere_cure + sphere_default + sphere_dead + 
      unicef_theme +
      theme(axis.text.x = element_text(size = 8, angle = 90),
            axis.text.y = element_text(size = 8))
  } else {
    z <- z + 
      unicef_theme +
      theme(axis.text.x = element_text(size = 8, angle = 90),
            axis.text.y = element_text(size = 8))
  }
  
  ggplotly(p = z)
})

plotlyOutput(outputId = "performanceStateOverall")
```

### Locality

```{r, fig.height = 5}
xLocalityOverall <- reactive({
  req(input$locality_name)
  monitoring %>% 
    calculate_performance() %>%
    filter(State == input$state_name,
           Locality == input$locality_name) %>%
    mutate(`Cure Rate` = cured_prop * 100,
           `Defaulter Rate` = defaulter_prop * 100,
           `Death Rate` = dead_prop * 100,
           `Non-response Rate` = nr_prop * 100,
           MonthYear = paste(Month, Year, sep = " "),
           MonthYear = factor(x = MonthYear, 
                              levels = c(paste(c("Jan", "Feb", "Mar", "Apr", 
                                                 "May", "Jun", "Jul", "Aug", 
                                                 "Sep", "Oct", "Nov", "Dec"), "2016"),
                                         paste(c("Jan", "Feb", "Mar", "Apr", 
                                                 "May", "Jun", "Jul", "Aug", 
                                                 "Sep", "Oct", "Nov", "Dec"), "2017"),
                                         paste(c("Jan", "Feb", "Mar", "Apr", 
                                                 "May", "Jun", "Jul", "Aug", 
                                                 "Sep", "Oct", "Nov", "Dec"), "2018"),
                                         paste(c("Jan", "Feb", "Mar", "Apr", 
                                                 "May", "Jun", "Jul", "Aug", 
                                                 "Sep", "Oct", "Nov", "Dec"), "2019"))))
})

output$performanceLocalityOverall <- renderPlotly({
  z <- xLocalityOverall() %>% 
    ggplot(mapping = aes(x = MonthYear, group = State)) +
    geom_line(mapping = aes(y = `Cure Rate`, colour = "Cure Rate"), size = 1) +
    geom_line(mapping = aes(y = `Death Rate`, colour = "Death Rate"), size = 1) +
    geom_line(mapping = aes(y = `Defaulter Rate`, colour = "Defaulter Rate"), size = 1) +
    geom_line(mapping = aes(y = `Non-response Rate`, colour = "Non-response Rate"),
              alpha = 0.5, size = 1) +
    scale_colour_manual(name = "",
                        values = c("Cure Rate" = "darkgreen", 
                                   "Death Rate" = "black", 
                                   "Defaulter Rate" = "red", 
                                   "Non-response Rate" = "gray50")) +
    scale_y_continuous(limits = c(0, 100),
                                  breaks = seq(from = 0, to = 100, by = 10)) +
    labs(title = paste("Performance over time - 2016 to 2019 - ",
                       input$locality_name, " Locality, ",
                       input$state_name, " State", sep = ""),
         y = "%", x = "")
  
  sphere_cure <- geom_hline(yintercept = 75, 
                            colour = "darkgreen", 
                            linetype = 2, size = 0.25)
  
  sphere_default <- geom_hline(yintercept = 15, 
                               colour = "red", 
                               linetype = 2, size = 0.25)
    
  sphere_dead <- geom_hline(yintercept = 10, 
                            colour = "black", 
                            linetype = 2, size = 0.25)
  
  ## Assemble plot
  if(input$standards) {
    z <- z + sphere_cure + sphere_default + sphere_dead + 
      unicef_theme +
      theme(axis.text.x = element_text(size = 8, angle = 90),
            axis.text.y = element_text(size = 8))
  } else {
    z <- z + 
      unicef_theme +
      theme(axis.text.x = element_text(size = 8, angle = 90),
            axis.text.y = element_text(size = 8))
  }
  
  ggplotly(p = z)
})

plotlyOutput(outputId = "performanceLocalityOverall")
```


Row {.tabset .tabset-fade}
--------------------------------------------------------------------------------

### National

```{r, fig.height = 8}
x <- reactive({
  aggregate(cbind(Cured, Death, Default, `Non-Responder`) ~ Month + Year, 
            data = monitoring, FUN = sum) %>% 
    calculate_performance() %>%
    filter(Year == input$chosen_year) %>%
    mutate(`Cure Rate` = cured_prop * 100,
           `Defaulter Rate` = defaulter_prop * 100,
           `Death Rate` = dead_prop * 100,
           `Non-response Rate` = nr_prop * 100,
           Month = factor(x = Month, 
                          levels = c("Jan", "Feb", "Mar", "Apr", "May", "Jun", 
                                     "Jul", "Aug", "Sep", "Oct", "Nov", "Dec")))
})

output$performance <- renderPlotly({
  z <- x() %>% 
    ggplot(mapping = aes(x = Month, group = Year)) +
    geom_line(mapping = aes(y = `Cure Rate`), colour = "darkgreen", size = 1) +
    geom_line(mapping = aes(y = `Death Rate`), colour = "black", size = 1) +
    geom_line(mapping = aes(y = `Defaulter Rate`), colour = "red", size = 1) +
    geom_line(mapping = aes(y = `Non-response Rate`), colour = "gray50", 
              alpha = 0.5, size = 1) +
    scale_y_continuous(limits = c(0, 100),
                                  breaks = seq(from = 0, to = 100, by = 10)) +
    labs(title = paste("Performance over time - Year ", input$chosen_year, sep = ""),
         y = "%", x = "")
  
  sphere_cure <- geom_hline(yintercept = 75, 
                            colour = "darkgreen", 
                            linetype = 2, size = 0.25)
  
  sphere_default <- geom_hline(yintercept = 15, 
                               colour = "red", 
                               linetype = 2, size = 0.25)
    
  sphere_dead <- geom_hline(yintercept = 10, 
                            colour = "black", 
                            linetype = 2, size = 0.25)
  
  ## Assemble plot
  if(input$standards) {
    z <- z + sphere_cure + sphere_default + sphere_dead + unicef_theme
  } else {
    z <- z + unicef_theme
  }
  
  ggplotly(p = z)
})

plotlyOutput(outputId = "performance")
```

### State

```{r}
xstate <- reactive({
  aggregate(cbind(Cured, Death, Default, `Non-Responder`) ~ State + Month + Year, 
               data = monitoring, FUN = sum) %>% 
    calculate_performance() %>%
    filter(Year == input$chosen_year) %>%
    mutate(`Cure Rate` = cured_prop * 100,
           `Defaulter Rate` = defaulter_prop * 100,
           `Death Rate` = dead_prop * 100,
           `Non-response Rate` = nr_prop * 100,
           Month = factor(x = Month, 
                          levels = c("Jan", "Feb", "Mar", "Apr", "May", "Jun", 
                                     "Jul", "Aug", "Sep", "Oct", "Nov", "Dec")))
})

output$state_performance <- renderPlotly({
  z <- xstate() %>%
    ggplot(mapping = aes(x = Month, group = State)) +
    geom_line(mapping = aes(y = `Cure Rate`), colour = "darkgreen", size = 1) +
    geom_line(mapping = aes(y = `Death Rate`), colour = "black", size = 1) +
    geom_line(mapping = aes(y = `Defaulter Rate`), colour = "red", size = 1) +
    geom_line(mapping = aes(y = `Non-response Rate`), colour = "gray50", 
              alpha = 0.5, size = 1) +
    scale_y_continuous(limits = c(0, 100),
                       breaks = seq(from = 0, to = 100, by = 10)) +
    labs(title = paste("Performance over time by state - Year ", input$chosen_year, sep = ""), 
         y = "%", x = "")
        
  sphere_cure <- geom_hline(yintercept = 75, 
                            colour = "darkgreen", 
                            linetype = 2, size = 0.25)
  
  sphere_default <- geom_hline(yintercept = 15, 
                               colour = "red", 
                               linetype = 2, size = 0.25)
    
  sphere_dead <- geom_hline(yintercept = 10, 
                            colour = "black", 
                            linetype = 2, size = 0.25)
  
  add_facets <- facet_wrap( ~ State, ncol = 6)

  if(input$standards) {
    z <- z + sphere_cure + sphere_default + sphere_dead + add_facets
  } else {
    z <- z + add_facets
  }

  z <- z + unicef_theme +
    theme(axis.text.x = element_text(size = 8, angle = 90),
          axis.text.y = element_text(size = 8))
  
  ggplotly(p = z)
})

plotlyOutput(outputId = "state_performance")
```

### Locality

```{r}
xlocality <- reactive({
  monitoring %>% 
    calculate_performance() %>%
    filter(Year == input$chosen_year,
           State == input$state_name) %>%
    mutate(`Cure Rate` = cured_prop * 100,
           `Defaulter Rate` = defaulter_prop * 100,
           `Death Rate` = dead_prop * 100,
           `Non-response Rate` = nr_prop * 100,
           Month = factor(x = Month, 
                          levels = c("Jan", "Feb", "Mar", "Apr", "May", "Jun", 
                                     "Jul", "Aug", "Sep", "Oct", "Nov", "Dec")))
})

output$locality_performance <- renderPlotly({
  z <- xlocality() %>%
    ggplot(mapping = aes(x = Month, group = Locality)) +
    geom_line(mapping = aes(y = `Cure Rate`), colour = "darkgreen", size = 1) +
    geom_line(mapping = aes(y = `Death Rate`), colour = "black", size = 1) +
    geom_line(mapping = aes(y = `Defaulter Rate`), colour = "red", size = 1) +
    geom_line(mapping = aes(y = `Non-response Rate`), colour = "gray50", 
              alpha = 0.5, size = 1) +
    scale_y_continuous(limits = c(0, 100),
                       breaks = seq(from = 0, to = 100, by = 10)) +
    labs(title = paste("Performance over time in ", input$state_name, 
                       " State by locality - Year ", input$chosen_year, sep = ""),
         y = "%", x = "")
    
  sphere_cure <- geom_hline(yintercept = 75, 
                            colour = "darkgreen", 
                            linetype = 2, size = 0.25)
  
  sphere_default <- geom_hline(yintercept = 15, 
                               colour = "red", 
                               linetype = 2, size = 0.25)
    
  sphere_dead <- geom_hline(yintercept = 10, 
                            colour = "black", 
                            linetype = 2, size = 0.25)
  
  add_facets <- facet_wrap( ~ Locality, nrow = 3)

  if(input$standards) {
    z <- z + sphere_cure + sphere_default + sphere_dead + add_facets
  } else {
    z <- z + add_facets
  }
  
  z <- z +
    unicef_theme +
    theme(axis.text.x = element_text(size = 8, angle = 90),
          axis.text.y = element_text(size = 8))
  
  ggplotly(p = z)
})

plotlyOutput(outputId = "locality_performance")
```

Row
--------------------------------------------------------------------------------

### Map of performance by state for a given month and year

```{r, fig.height = 5}
output$statePerformanceMap <- renderLeaflet({
  leaflet()
})

observeEvent(input$map_tiles, {
  leafletProxy("statePerformanceMap") %>%
    addTiles(urlTemplate = get(input$map_tiles),
             attribution = "Map by <a href='http://www.mapbox.com/'>Mapbox</a>")
})

observeEvent(input$indicator, {
  xx <- aggregate(cbind(Cured, Death, Default, `Non-Responder`) ~ State + Month + Year, 
                  data = monitoring, FUN = sum) %>% 
    calculate_performance() %>%
    filter(Year == input$chosen_year,
           Month == input$chosen_month) %>%
    mutate(`Cure Rate` = cured_prop * 100,
           `Defaulter Rate` = defaulter_prop * 100,
           `Death Rate` = dead_prop * 100,
           `Non-response Rate` = nr_prop * 100,
           Month = factor(x = Month, 
                          levels = c("Jan", "Feb", "Mar", "Apr", "May", "Jun", 
                                     "Jul", "Aug", "Sep", "Oct", "Nov", "Dec")))  
  
  state_map <- states
  state_map@data <- merge(state_map@data, xx, 
                          by.x = "State_En", 
                          by.y = "State",
                          all.x = TRUE)
  
  state_map@data <- state_map@data[order(as.numeric(state_map$OBJECTID_1)), ]
  
  if(input$indicator == "Cure Rate") {
    mapPalette <- brewer.pal(n = 6, name = "RdYlGn")
    pal <- colorBin(palette = mapPalette,
                    domain = c(0, 100),
                    bins = c(0, 75, 80, 85, 90, 95, 100))
  } else {
    mapPalette <- brewer.pal(n = 5, name = "RdYlGn")
    
    if(input$indicator == "Defaulter Rate") {
    pal <- colorBin(palette = mapPalette,
                    domain = c(0, 100),
                    bins = c(0, 1, 5, 10, 15, 100),
                    reverse = TRUE)
    }
    
    if(input$indicator == "Death Rate") {
    pal <- colorBin(palette = mapPalette,
                    domain = c(0, 100),
                    bins = c(0, 2, 5, 8, 10, 100),
                    reverse = TRUE)
    }  
  
    if(input$indicator == "Non-response Rate") {
    pal <- colorBin(palette = mapPalette,
                    domain = c(0, 100),
                    bins = c(0, 2, 3, 4, 5, 100),
                    reverse = TRUE)
    }    
  }
  
  leafletProxy("statePerformanceMap") %>%
    clearControls() %>%
    clearShapes() %>%
    fitBounds(lng1 = bbox(state_map)[1, 1], lat1 = bbox(state_map)[2, 1],
              lng2 = bbox(state_map)[1, 2], lat2 = bbox(state_map)[2, 2]) %>%
    addPolygons(data = state_map,
                fillColor = pal(state_map[[input$indicator]]),
                weight = 2,
                opacity = 1,
                color = pal(state_map[[input$indicator]]),
                dashArray = "",
                fillOpacity = 0.8,
                highlight = highlightOptions(weight = 3,
                                             color = "#666",
                                             dashArray = "",
                                             fillOpacity = 0.7,
                                             bringToFront = TRUE),
                label = paste("<strong>", state_map[["State_En"]], 
                              " State</strong><br/><strong>", input$indicator,
                              ":</strong> ", 
                              round(state_map[[input$indicator]], digits = 2), 
                              "%<br/>", input$chosen_month, " ", 
                              input$chosen_year, sep = "") %>%
                  lapply(FUN = htmltools::HTML),
                labelOptions = labelOptions(style = list("font-weight" = "normal", 
                                                             padding = "3px 8px"),
                                            textsize = "12px",
                                            direction = "auto")) %>%
    addLegend(pal = pal, 
              values = c(0, 100),
              title = htmltools::HTML(
                paste(input$indicator, "<br/>", input$chosen_month, 
                      " ",  input$chosen_year, sep = "")),
              opacity = 0.7,
              position = "bottomright", 
              labFormat = legend.format(digits = 1, between = " to ", suffix = "%"),
              layerId = "legend")
})

observeEvent(input$chosen_month, {
  xx <- aggregate(cbind(Cured, Death, Default, `Non-Responder`) ~ State + Month + Year, 
                  data = monitoring, FUN = sum) %>% 
    calculate_performance() %>%
    filter(Year == input$chosen_year,
           Month == input$chosen_month) %>%
    mutate(`Cure Rate` = cured_prop * 100,
           `Defaulter Rate` = defaulter_prop * 100,
           `Death Rate` = dead_prop * 100,
           `Non-response Rate` = nr_prop * 100,
           Month = factor(x = Month, 
                          levels = c("Jan", "Feb", "Mar", "Apr", "May", "Jun", 
                                     "Jul", "Aug", "Sep", "Oct", "Nov", "Dec")))  
  
  state_map <- states
  state_map@data <- merge(state_map@data, xx, 
                          by.x = "State_En", 
                          by.y = "State",
                          all.x = TRUE)
  
  state_map@data <- state_map@data[order(as.numeric(state_map$OBJECTID_1)), ]
  
  if(input$indicator == "Cure Rate") {
    mapPalette <- brewer.pal(n = 6, name = "RdYlGn")
    pal <- colorBin(palette = mapPalette,
                    domain = c(0, 100),
                    bins = c(0, 75, 80, 85, 90, 95, 100))
  } else {
    mapPalette <- brewer.pal(n = 5, name = "RdYlGn")
    
    if(input$indicator == "Defaulter Rate") {
    pal <- colorBin(palette = mapPalette,
                    domain = c(0, 100),
                    bins = c(0, 1, 5, 10, 15, 100),
                    reverse = TRUE)
    }
    
    if(input$indicator == "Death Rate") {
    pal <- colorBin(palette = mapPalette,
                    domain = c(0, 100),
                    bins = c(0, 2, 5, 8, 10, 100),
                    reverse = TRUE)
    }  
  
    if(input$indicator == "Non-response Rate") {
    pal <- colorBin(palette = mapPalette,
                    domain = c(0, 100),
                    bins = c(0, 2, 3, 4, 5, 100),
                    reverse = TRUE)
    }    
  }
  
  leafletProxy("statePerformanceMap") %>%
    clearControls() %>%
    clearShapes() %>%
    fitBounds(lng1 = bbox(state_map)[1, 1], lat1 = bbox(state_map)[2, 1],
              lng2 = bbox(state_map)[1, 2], lat2 = bbox(state_map)[2, 2]) %>%
    addPolygons(data = state_map,
                fillColor = pal(state_map[[input$indicator]]),
                weight = 2,
                opacity = 1,
                color = pal(state_map[[input$indicator]]),
                dashArray = "",
                fillOpacity = 0.8,
                highlight = highlightOptions(weight = 3,
                                             color = "#666",
                                             dashArray = "",
                                             fillOpacity = 0.7,
                                             bringToFront = TRUE),
                label = paste("<strong>", state_map[["State_En"]], 
                              " State</strong><br/><strong>", input$indicator,
                              ":</strong> ", 
                              round(state_map[[input$indicator]], digits = 2), 
                              "%<br/>", input$chosen_month, " ", 
                              input$chosen_year, sep = "") %>%
                  lapply(FUN = htmltools::HTML),
                labelOptions = labelOptions(style = list("font-weight" = "normal", 
                                                             padding = "3px 8px"),
                                            textsize = "12px",
                                            direction = "auto")) %>%
    addLegend(pal = pal, 
              values = c(0, 100),
              title = htmltools::HTML(
                paste(input$indicator, "<br/>", input$chosen_month, 
                      " ",  input$chosen_year, sep = "")),
              opacity = 0.7,
              position = "bottomright", 
              labFormat = legend.format(digits = 1, between = " to ", suffix = "%"),
              layerId = "legend")
})

observeEvent(input$chosen_year, {
  xx <- aggregate(cbind(Cured, Death, Default, `Non-Responder`) ~ State + Month + Year, 
                  data = monitoring, FUN = sum) %>% 
    calculate_performance() %>%
    filter(Year == input$chosen_year,
           Month == input$chosen_month) %>%
    mutate(`Cure Rate` = cured_prop * 100,
           `Defaulter Rate` = defaulter_prop * 100,
           `Death Rate` = dead_prop * 100,
           `Non-response Rate` = nr_prop * 100,
           Month = factor(x = Month, 
                          levels = c("Jan", "Feb", "Mar", "Apr", "May", "Jun", 
                                     "Jul", "Aug", "Sep", "Oct", "Nov", "Dec")))  
  
  state_map <- states
  state_map@data <- merge(state_map@data, xx, 
                          by.x = "State_En", 
                          by.y = "State",
                          all.x = TRUE)
  
  state_map@data <- state_map@data[order(as.numeric(state_map$OBJECTID_1)), ]
  
  if(input$indicator == "Cure Rate") {
    mapPalette <- brewer.pal(n = 6, name = "RdYlGn")
    pal <- colorBin(palette = mapPalette,
                    domain = c(0, 100),
                    bins = c(0, 75, 80, 85, 90, 95, 100))
  } else {
    mapPalette <- brewer.pal(n = 5, name = "RdYlGn")
    
    if(input$indicator == "Defaulter Rate") {
    pal <- colorBin(palette = mapPalette,
                    domain = c(0, 100),
                    bins = c(0, 1, 5, 10, 15, 100),
                    reverse = TRUE)
    }
    
    if(input$indicator == "Death Rate") {
    pal <- colorBin(palette = mapPalette,
                    domain = c(0, 100),
                    bins = c(0, 2, 5, 8, 10, 100),
                    reverse = TRUE)
    }  
  
    if(input$indicator == "Non-response Rate") {
    pal <- colorBin(palette = mapPalette,
                    domain = c(0, 100),
                    bins = c(0, 2, 3, 4, 5, 100),
                    reverse = TRUE)
    }    
  }
  
  leafletProxy("statePerformanceMap") %>%
    clearControls() %>%
    clearShapes() %>%
    fitBounds(lng1 = bbox(state_map)[1, 1], lat1 = bbox(state_map)[2, 1],
              lng2 = bbox(state_map)[1, 2], lat2 = bbox(state_map)[2, 2]) %>%
    addPolygons(data = state_map,
                fillColor = pal(state_map[[input$indicator]]),
                weight = 2,
                opacity = 1,
                color = pal(state_map[[input$indicator]]),
                dashArray = "",
                fillOpacity = 0.8,
                highlight = highlightOptions(weight = 3,
                                             color = "#666",
                                             dashArray = "",
                                             fillOpacity = 0.7,
                                             bringToFront = TRUE),
                label = paste("<strong>", state_map[["State_En"]], 
                              " State</strong><br/><strong>", input$indicator,
                              ":</strong> ", 
                              round(state_map[[input$indicator]], digits = 2), 
                              "%<br/>", input$chosen_month, " ", 
                              input$chosen_year, sep = "") %>%
                  lapply(FUN = htmltools::HTML),
                labelOptions = labelOptions(style = list("font-weight" = "normal", 
                                                             padding = "3px 8px"),
                                            textsize = "12px",
                                            direction = "auto")) %>%
    addLegend(pal = pal, 
              values = c(0, 100),
              title = htmltools::HTML(
                paste(input$indicator, "<br/>", input$chosen_month, 
                      " ",  input$chosen_year, sep = "")),
              opacity = 0.7,
              position = "bottomright", 
              labFormat = legend.format(digits = 1, between = " to ", suffix = "%"),
              layerId = "legend")
})

leafletOutput(outputId = "statePerformanceMap")
```

### Map of performance by locality for a given state, month and year

```{r, fig.height = 5, eval = TRUE}
output$localityPerformanceMap <- renderLeaflet({
  leaflet()
})

observeEvent(input$map_tiles, {
  leafletProxy("localityPerformanceMap") %>%
    addTiles(urlTemplate = get(input$map_tiles),
             attribution = "Map by <a href='http://www.mapbox.com/'>Mapbox</a>")
})

observeEvent(input$indicator, {
  xx <- monitoring %>% 
    filter(Year == input$chosen_year,
           Month == input$chosen_month,
           State == input$state_name) %>%
    calculate_performance() %>%
    mutate(`Cure Rate` = cured_prop * 100,
           `Defaulter Rate` = defaulter_prop * 100,
           `Death Rate` = dead_prop * 100,
           `Non-response Rate` = nr_prop * 100,
           Month = factor(x = Month, 
                          levels = c("Jan", "Feb", "Mar", "Apr", "May", "Jun", 
                                     "Jul", "Aug", "Sep", "Oct", "Nov", "Dec")))  
  
  locality_map <- localities
  locality_map <- subset(locality_map, State_En == input$state_name)
  locality_map@data <- merge(locality_map@data, xx, 
                             by.x = "Name_Engli", 
                             by.y = "Locality",
                             all.x = TRUE)
    
  locality_map@data <- locality_map@data[order(as.numeric(locality_map$OBJECTID)), ]

  if(input$indicator == "Cure Rate") {
    mapPalette <- brewer.pal(n = 6, name = "RdYlGn")
    pal <- colorBin(palette = mapPalette,
                    domain = c(0, 100),
                    bins = c(0, 75, 80, 85, 90, 95, 100))
  } else {
    mapPalette <- brewer.pal(n = 5, name = "RdYlGn")
    
    if(input$indicator == "Defaulter Rate") {
    pal <- colorBin(palette = mapPalette,
                    domain = c(0, 100),
                    bins = c(0, 1, 5, 10, 15, 100),
                    reverse = TRUE)
    }
    
    if(input$indicator == "Death Rate") {
    pal <- colorBin(palette = mapPalette,
                    domain = c(0, 100),
                    bins = c(0, 2, 5, 8, 10, 100),
                    reverse = TRUE)
    }  
  
    if(input$indicator == "Non-response Rate") {
    pal <- colorBin(palette = mapPalette,
                    domain = c(0, 100),
                    bins = c(0, 2, 3, 4, 5, 100),
                    reverse = TRUE)
    }    
  }
  
  leafletProxy("localityPerformanceMap") %>%
    clearControls() %>%
    clearShapes() %>%
    fitBounds(lng1 = bbox(locality_map)[1, 1], lat1 = bbox(locality_map)[2, 1],
              lng2 = bbox(locality_map)[1, 2], lat2 = bbox(locality_map)[2, 2]) %>%
    addPolygons(data = locality_map,
                fillColor = pal(locality_map[[input$indicator]]),
                weight = 2,
                opacity = 1,
                color = pal(locality_map[[input$indicator]]),
                dashArray = "",
                fillOpacity = 0.8,
                highlight = highlightOptions(weight = 3,
                                             color = "#666",
                                             dashArray = "",
                                             fillOpacity = 0.7,
                                             bringToFront = TRUE),
                label = paste("<strong>", locality_map[["Name_Engli"]], 
                              " Locality</strong><br/><strong>", 
                              locality_map[["State_En"]], 
                              " State</strong><br/><strong>", input$indicator,
                              ":</strong> ", 
                              round(locality_map[[input$indicator]], digits = 2), 
                              "%<br/>", input$chosen_month, " ", 
                              input$chosen_year, sep = "") %>%
                  lapply(FUN = htmltools::HTML),
                labelOptions = labelOptions(style = list("font-weight" = "normal", 
                                                             padding = "3px 8px"),
                                            textsize = "12px",
                                            direction = "auto")) %>%
    addLegend(pal = pal, 
              values = c(0, 100),
              title = htmltools::HTML(
                paste(input$indicator, "<br/>", 
                      input$state_name, " State<br/>",
                      input$chosen_month, 
                      " ",  input$chosen_year, sep = "")),
              opacity = 0.7,
              position = "bottomright", 
              labFormat = legend.format(digits = 1, between = " to ", suffix = "%"),
              layerId = "legend")
})

observeEvent(input$chosen_month, {
  xx <- monitoring %>% 
    filter(Year == input$chosen_year,
           Month == input$chosen_month,
           State == input$state_name) %>%
    calculate_performance() %>%
    mutate(`Cure Rate` = cured_prop * 100,
           `Defaulter Rate` = defaulter_prop * 100,
           `Death Rate` = dead_prop * 100,
           `Non-response Rate` = nr_prop * 100,
           Month = factor(x = Month, 
                          levels = c("Jan", "Feb", "Mar", "Apr", "May", "Jun", 
                                     "Jul", "Aug", "Sep", "Oct", "Nov", "Dec")))  
  
  locality_map <- localities
  locality_map <- subset(locality_map, State_En == input$state_name)
  locality_map@data <- merge(locality_map@data, xx, 
                             by.x = "Name_Engli", 
                             by.y = "Locality",
                             all.x = TRUE)
    
  locality_map@data <- locality_map@data[order(as.numeric(locality_map$OBJECTID)), ]
    
  if(input$indicator == "Cure Rate") {
    mapPalette <- brewer.pal(n = 6, name = "RdYlGn")
    pal <- colorBin(palette = mapPalette,
                    domain = c(0, 100),
                    bins = c(0, 75, 80, 85, 90, 95, 100))
  } else {
    mapPalette <- brewer.pal(n = 5, name = "RdYlGn")
    
    if(input$indicator == "Defaulter Rate") {
    pal <- colorBin(palette = mapPalette,
                    domain = c(0, 100),
                    bins = c(0, 1, 5, 10, 15, 100),
                    reverse = TRUE)
    }
    
    if(input$indicator == "Death Rate") {
    pal <- colorBin(palette = mapPalette,
                    domain = c(0, 100),
                    bins = c(0, 2, 5, 8, 10, 100),
                    reverse = TRUE)
    }  
  
    if(input$indicator == "Non-response Rate") {
    pal <- colorBin(palette = mapPalette,
                    domain = c(0, 100),
                    bins = c(0, 2, 3, 4, 5, 100),
                    reverse = TRUE)
    }    
  }
  
  leafletProxy("localityPerformanceMap") %>%
    clearControls() %>%
    clearShapes() %>%
    fitBounds(lng1 = bbox(locality_map)[1, 1], lat1 = bbox(locality_map)[2, 1],
              lng2 = bbox(locality_map)[1, 2], lat2 = bbox(locality_map)[2, 2]) %>%
    addPolygons(data = locality_map,
                fillColor = pal(locality_map[[input$indicator]]),
                weight = 2,
                opacity = 1,
                color = pal(locality_map[[input$indicator]]),
                dashArray = "",
                fillOpacity = 0.8,
                highlight = highlightOptions(weight = 3,
                                             color = "#666",
                                             dashArray = "",
                                             fillOpacity = 0.7,
                                             bringToFront = TRUE),
                label = paste("<strong>", locality_map[["Name_Engli"]], 
                              " Locality</strong><br/><strong>", 
                              locality_map[["State_En"]], 
                              " State</strong><br/><strong>", input$indicator,
                              ":</strong> ", 
                              round(locality_map[[input$indicator]], digits = 2), 
                              "%<br/>", input$chosen_month, " ", 
                              input$chosen_year, sep = "") %>%
                  lapply(FUN = htmltools::HTML),
                labelOptions = labelOptions(style = list("font-weight" = "normal", 
                                                             padding = "3px 8px"),
                                            textsize = "12px",
                                            direction = "auto")) %>%
    addLegend(pal = pal, 
              values = c(0, 100),
              title = htmltools::HTML(
                paste(input$indicator, "<br/>", 
                      input$state_name, " State<br/>",
                      input$chosen_month, 
                      " ",  input$chosen_year, sep = "")),
              opacity = 0.7,
              position = "bottomright", 
              labFormat = legend.format(digits = 1, between = " to ", suffix = "%"),
              layerId = "legend")
})

observeEvent(input$chosen_year, {
  xx <- monitoring %>% 
    filter(Year == input$chosen_year,
           Month == input$chosen_month,
           State == input$state_name) %>%
    calculate_performance() %>%
    mutate(`Cure Rate` = cured_prop * 100,
           `Defaulter Rate` = defaulter_prop * 100,
           `Death Rate` = dead_prop * 100,
           `Non-response Rate` = nr_prop * 100,
           Month = factor(x = Month, 
                          levels = c("Jan", "Feb", "Mar", "Apr", "May", "Jun", 
                                     "Jul", "Aug", "Sep", "Oct", "Nov", "Dec")))  
  
  locality_map <- localities
  locality_map <- subset(locality_map, State_En == input$state_name)
  locality_map@data <- merge(locality_map@data, xx, 
                             by.x = "Name_Engli", 
                             by.y = "Locality",
                             all.x = TRUE)
    
  locality_map@data <- locality_map@data[order(as.numeric(locality_map$OBJECTID)), ]
    
  if(input$indicator == "Cure Rate") {
    mapPalette <- brewer.pal(n = 6, name = "RdYlGn")
    pal <- colorBin(palette = mapPalette,
                    domain = c(0, 100),
                    bins = c(0, 75, 80, 85, 90, 95, 100))
  } else {
    mapPalette <- brewer.pal(n = 5, name = "RdYlGn")
    
    if(input$indicator == "Defaulter Rate") {
    pal <- colorBin(palette = mapPalette,
                    domain = c(0, 100),
                    bins = c(0, 1, 5, 10, 15, 100),
                    reverse = TRUE)
    }
    
    if(input$indicator == "Death Rate") {
    pal <- colorBin(palette = mapPalette,
                    domain = c(0, 100),
                    bins = c(0, 2, 5, 8, 10, 100),
                    reverse = TRUE)
    }  
  
    if(input$indicator == "Non-response Rate") {
    pal <- colorBin(palette = mapPalette,
                    domain = c(0, 100),
                    bins = c(0, 2, 3, 4, 5, 100),
                    reverse = TRUE)
    }    
  }
  
  leafletProxy("localityPerformanceMap") %>%
    clearControls() %>%
    clearShapes() %>%
    fitBounds(lng1 = bbox(locality_map)[1, 1], lat1 = bbox(locality_map)[2, 1],
              lng2 = bbox(locality_map)[1, 2], lat2 = bbox(locality_map)[2, 2]) %>%
    addPolygons(data = locality_map,
                fillColor = pal(locality_map[[input$indicator]]),
                weight = 2,
                opacity = 1,
                color = pal(locality_map[[input$indicator]]),
                dashArray = "",
                fillOpacity = 0.8,
                highlight = highlightOptions(weight = 3,
                                             color = "#666",
                                             dashArray = "",
                                             fillOpacity = 0.7,
                                             bringToFront = TRUE),
                label = paste("<strong>", locality_map[["Name_Engli"]], 
                              " Locality</strong><br/><strong>", 
                              locality_map[["State_En"]], 
                              " State</strong><br/><strong>", input$indicator,
                              ":</strong> ", 
                              round(locality_map[[input$indicator]], digits = 2), 
                              "%<br/>", input$chosen_month, " ", 
                              input$chosen_year, sep = "") %>%
                  lapply(FUN = htmltools::HTML),
                labelOptions = labelOptions(style = list("font-weight" = "normal", 
                                                             padding = "3px 8px"),
                                            textsize = "12px",
                                            direction = "auto")) %>%
    addLegend(pal = pal, 
              values = c(0, 100),
              title = htmltools::HTML(
                paste(input$indicator, "<br/>", 
                      input$state_name, " State<br/>",
                      input$chosen_month, 
                      " ",  input$chosen_year, sep = "")),
              opacity = 0.7,
              position = "bottomright", 
              labFormat = legend.format(digits = 1, between = " to ", suffix = "%"),
              layerId = "legend")
})

observeEvent(input$state_name, {
  xx <- monitoring %>% 
    filter(Year == input$chosen_year,
           Month == input$chosen_month,
           State == input$state_name) %>%
    calculate_performance() %>%
    mutate(`Cure Rate` = cured_prop * 100,
           `Defaulter Rate` = defaulter_prop * 100,
           `Death Rate` = dead_prop * 100,
           `Non-response Rate` = nr_prop * 100,
           Month = factor(x = Month, 
                          levels = c("Jan", "Feb", "Mar", "Apr", "May", "Jun", 
                                     "Jul", "Aug", "Sep", "Oct", "Nov", "Dec")))  
  
  locality_map <- localities
  locality_map <- subset(locality_map, State_En == input$state_name)
  locality_map@data <- merge(locality_map@data, xx, 
                             by.x = "Name_Engli", 
                             by.y = "Locality",
                             all.x = TRUE)
    
  locality_map@data <- locality_map@data[order(as.numeric(locality_map$OBJECTID)), ]
    
  if(input$indicator == "Cure Rate") {
    mapPalette <- brewer.pal(n = 6, name = "RdYlGn")
    pal <- colorBin(palette = mapPalette,
                    domain = c(0, 100),
                    bins = c(0, 75, 80, 85, 90, 95, 100))
  } else {
    mapPalette <- brewer.pal(n = 5, name = "RdYlGn")
    
    if(input$indicator == "Defaulter Rate") {
    pal <- colorBin(palette = mapPalette,
                    domain = c(0, 100),
                    bins = c(0, 1, 5, 10, 15, 100),
                    reverse = TRUE)
    }
    
    if(input$indicator == "Death Rate") {
    pal <- colorBin(palette = mapPalette,
                    domain = c(0, 100),
                    bins = c(0, 2, 5, 8, 10, 100),
                    reverse = TRUE)
    }  
  
    if(input$indicator == "Non-response Rate") {
    pal <- colorBin(palette = mapPalette,
                    domain = c(0, 100),
                    bins = c(0, 2, 3, 4, 5, 100),
                    reverse = TRUE)
    }    
  }
  
  leafletProxy("localityPerformanceMap") %>%
    clearControls() %>%
    clearShapes() %>%
    fitBounds(lng1 = bbox(locality_map)[1, 1], lat1 = bbox(locality_map)[2, 1],
              lng2 = bbox(locality_map)[1, 2], lat2 = bbox(locality_map)[2, 2]) %>%
    addPolygons(data = locality_map,
                fillColor = pal(locality_map[[input$indicator]]),
                weight = 2,
                opacity = 1,
                color = pal(locality_map[[input$indicator]]),
                dashArray = "",
                fillOpacity = 0.8,
                highlight = highlightOptions(weight = 3,
                                             color = "#666",
                                             dashArray = "",
                                             fillOpacity = 0.7,
                                             bringToFront = TRUE),
                label = paste("<strong>", locality_map[["Name_Engli"]], 
                              " Locality</strong><br/><strong>", 
                              locality_map[["State_En"]], 
                              " State</strong><br/><strong>", input$indicator,
                              ":</strong> ", 
                              round(locality_map[[input$indicator]], digits = 2), 
                              "%<br/>", input$chosen_month, " ", 
                              input$chosen_year, sep = "") %>%
                  lapply(FUN = htmltools::HTML),
                labelOptions = labelOptions(style = list("font-weight" = "normal", 
                                                             padding = "3px 8px"),
                                            textsize = "12px",
                                            direction = "auto")) %>%
    addLegend(pal = pal, 
              values = c(0, 100),
              title = htmltools::HTML(
                paste(input$indicator, "<br/>", 
                      input$state_name, " State<br/>",
                      input$chosen_month, 
                      " ",  input$chosen_year, sep = "")),
              opacity = 0.7,
              position = "bottomright", 
              labFormat = legend.format(digits = 1, between = " to ", suffix = "%"),
              layerId = "legend")
})

leafletOutput(outputId = "localityPerformanceMap")
```

Responsiveness
================================================================================

Row {.tabset .tabset-fade}
--------------------------------------------------------------------------------

### Admissions - National

```{r, fig.height = 5}
overall_admissions_defaulters <- reactive({
  aggregate(cbind(`New Admissions`, Default) ~ Month + Year, 
            data = monitoring, FUN = sum) %>% 
    mutate(MonthYear = paste(Month, Year, sep = " "),
           MonthYear = factor(x = MonthYear, 
                              levels = c(paste(c("Jan", "Feb", "Mar", "Apr", 
                                                 "May", "Jun", "Jul", "Aug", 
                                                 "Sep", "Oct", "Nov", "Dec"), "2016"),
                                         paste(c("Jan", "Feb", "Mar", "Apr", 
                                                 "May", "Jun", "Jul", "Aug", 
                                                 "Sep", "Oct", "Nov", "Dec"), "2017"),
                                         paste(c("Jan", "Feb", "Mar", "Apr", 
                                                 "May", "Jun", "Jul", "Aug", 
                                                 "Sep", "Oct", "Nov", "Dec"), "2018"),
                                         paste(c("Jan", "Feb", "Mar", "Apr", 
                                                 "May", "Jun", "Jul", "Aug", 
                                                 "Sep", "Oct", "Nov", "Dec"), "2019")))) %>%
    arrange(MonthYear) %>%
    mutate(`Admissions (smoothed)` = smooth_m3a3(x = `New Admissions`),
           `Defaulters (smoothed)` = smooth_m3a3(x = Default))
})

season_long <- reactive({
  seasonal_calendar %>%
    mutate(start = paste(month.abb[month(as.Date(start))], year(as.Date(start))),
           end = paste(month.abb[month(as.Date(end))], year(as.Date(end))))
})

output$overall_admissions <- renderPlotly({
  z <- overall_admissions_defaulters() %>%
    ggplot() +
    geom_line(mapping = aes(x = MonthYear, y = `New Admissions`, group = 1,
                            text = paste(MonthYear, "\nNew Admissions: ", 
                                         `New Admissions`, sep = "")),
              colour = "blue", linetype = 1, size = 2)
  
  if(input$smooth) {
    z <- z +
      geom_line(mapping = aes(x = MonthYear, y = `Admissions (smoothed)`, group = 1,
                              text = "Admissions (smoothed)"),
                colour = "blue", alpha = 0.5, linetype = 2, size = 2)
  }
  
  if(input$showCalendar) {
    z <- z +
      geom_rect(mapping = aes(xmin = start, xmax = end,
                              ymin = 0, ymax = 2000, fill = group,
                              text = event),
                data = season_long() %>% filter(group == "Food availability")) +
      geom_rect(mapping = aes(xmin = start, xmax = end,
                              ymin = 2500, ymax = 4500, fill = group,
                              text = event),
                data = season_long() %>% filter(group == "Planting")) +
      geom_rect(mapping = aes(xmin = start, xmax = end,
                              ymin = 5000, ymax = 7000, fill = group,
                              text = event),
                data = season_long() %>% filter(group == "Rainfall"))
  }
  
  z <- z + 
    scale_y_continuous(limits = c(0, max(overall_admissions_defaulters()[["New Admissions"]])),
                       breaks = seq(from = 0, 
                                    to = max(overall_admissions_defaulters()[["New Admissions"]]),
                                    by = 5000)) +
    labs(title = "Admissions over time - 2016 to 2019", x = "") +
    unicef_theme +
    theme(axis.text.x = element_text(size = 8, angle = 90),
          axis.text.y = element_text(size = 8))
  
  ggplotly(p = z, tooltip = "text") %>%
    layout(legend = list(orientation = "h"))
})

plotlyOutput(outputId = "overall_admissions")
```

### Admissions - State

```{r, fig.height = 5}
overall_state_admissions_defaulters <- reactive({
  aggregate(cbind(`New Admissions`, Default) ~ State + Month + Year, 
            data = monitoring, FUN = sum) %>%
    filter(State == input$state_name) %>%
    mutate(MonthYear = paste(Month, Year, sep = " "),
           MonthYear = factor(x = MonthYear, 
                              levels = c(paste(c("Jan", "Feb", "Mar", "Apr", 
                                                 "May", "Jun", "Jul", "Aug", 
                                                 "Sep", "Oct", "Nov", "Dec"), "2016"),
                                         paste(c("Jan", "Feb", "Mar", "Apr", 
                                                 "May", "Jun", "Jul", "Aug", 
                                                 "Sep", "Oct", "Nov", "Dec"), "2017"),
                                         paste(c("Jan", "Feb", "Mar", "Apr", 
                                                 "May", "Jun", "Jul", "Aug", 
                                                 "Sep", "Oct", "Nov", "Dec"), "2018"),
                                         paste(c("Jan", "Feb", "Mar", "Apr", 
                                                 "May", "Jun", "Jul", "Aug", 
                                                 "Sep", "Oct", "Nov", "Dec"), "2019")))) %>%
    arrange(MonthYear) %>%
    mutate(`Admissions (smoothed)` = smooth_m3a3(x = `New Admissions`),
           `Defaulters (smoothed)` = smooth_m3a3(x = Default))
})

output$overall_state_admissions <- renderPlotly({
  z <- overall_state_admissions_defaulters() %>%
    ggplot(mapping = aes(x = MonthYear, group = 1)) +
    geom_line(mapping = aes(y = `New Admissions`), 
              colour = "blue", linetype = 1, size = 2) +
    scale_y_continuous(limits = c(0, max(overall_state_admissions_defaulters()[["New Admissions"]]))) +
    labs(title = paste("Admissions over time - 2016 to 2019 - ", input$state_name, " State", sep = ""), 
                       x = "")

  if(input$smooth) {
    z <- z +
      geom_line(mapping = aes(y = `Admissions (smoothed)`), 
                colour = "blue", alpha = 0.5, linetype = 2, size = 2)
  }
  
  z <- z + 
    unicef_theme +
    theme(axis.text.x = element_text(size = 8, angle = 90),
          axis.text.y = element_text(size = 8))
  
  ggplotly(p = z)
})

plotlyOutput(outputId = "overall_state_admissions")
```

### Admissions - Locality

```{r, fig.height = 5}
overall_locality_admissions_defaulters <- reactive({
  req(input$locality_name)
  monitoring %>%
    filter(State == input$state_name,
           Locality == input$locality_name) %>%
    mutate(MonthYear = paste(Month, Year, sep = " "),
           MonthYear = factor(x = MonthYear, 
                              levels = c(paste(c("Jan", "Feb", "Mar", "Apr", 
                                                 "May", "Jun", "Jul", "Aug", 
                                                 "Sep", "Oct", "Nov", "Dec"), "2016"),
                                         paste(c("Jan", "Feb", "Mar", "Apr", 
                                                 "May", "Jun", "Jul", "Aug", 
                                                 "Sep", "Oct", "Nov", "Dec"), "2017"),
                                         paste(c("Jan", "Feb", "Mar", "Apr", 
                                                 "May", "Jun", "Jul", "Aug", 
                                                 "Sep", "Oct", "Nov", "Dec"), "2018"),
                                         paste(c("Jan", "Feb", "Mar", "Apr", 
                                                 "May", "Jun", "Jul", "Aug", 
                                                 "Sep", "Oct", "Nov", "Dec"), "2019")))) %>%
    arrange(MonthYear) %>%
    mutate(`Admissions (smoothed)` = smooth_m3a3(x = `New Admissions`),
           `Defaulters (smoothed)` = smooth_m3a3(x = Default))
})

output$overall_locality_admissions <- renderPlotly({
  z <- overall_locality_admissions_defaulters() %>%
    ggplot(mapping = aes(x = MonthYear, group = 1)) +
    geom_line(mapping = aes(y = `New Admissions`), 
              colour = "blue", linetype = 1, size = 2) +
    scale_y_continuous(limits = c(0, max(overall_locality_admissions_defaulters()[["New Admissions"]]))) +
    labs(title = paste("Admissions over time - 2016 to 2019 - ",
                       input$locality_name, " Locality, ",
                       input$state_name, " State", sep = ""), 
                       x = "")

  if(input$smooth) {
    z <- z +
      geom_line(mapping = aes(y = `Admissions (smoothed)`), 
                colour = "blue", alpha = 0.5, linetype = 2, size = 2)
  }
  
  z <- z + 
    unicef_theme +
    theme(axis.text.x = element_text(size = 8, angle = 90),
          axis.text.y = element_text(size = 8))
  
  ggplotly(p = z)
})

plotlyOutput(outputId = "overall_locality_admissions")
```

Row {.tabset .tabset-fade}
--------------------------------------------------------------------------------

### Defaulters - National

```{r, fig.height = 5}
output$overall_defaulters <- renderPlotly({
  z <- overall_admissions_defaulters() %>%
    ggplot(mapping = aes(x = MonthYear, group = 1)) +
    geom_line(mapping = aes(y = Default), 
              colour = "red", linetype = 1, size = 2) +
    scale_y_continuous(limits = c(0, max(overall_admissions_defaulters()[["Default"]])),
                       breaks = seq(from = 0, 
                                    to = max(overall_admissions_defaulters()[["Default"]]),
                                    by = 500)) +
    labs(title = "Defaulters over time - 2016 to 2019", x = "")

  if(input$smooth) {
    z <- z +
      geom_line(mapping = aes(y = `Defaulters (smoothed)`), 
                colour = "red", alpha = 0.5, linetype = 2, size = 2)
  }
  
  z <- z + 
    unicef_theme +
    theme(axis.text.x = element_text(size = 8, angle = 90),
          axis.text.y = element_text(size = 8))
  
  ggplotly(p = z)
})

plotlyOutput(outputId = "overall_defaulters")
```

### Defaulters - State

```{r, fig.height = 5}
output$overall_state_defaulters <- renderPlotly({
  z <- overall_state_admissions_defaulters() %>%
    ggplot(mapping = aes(x = MonthYear, group = 1)) +
    geom_line(mapping = aes(y = Default), 
              colour = "red", linetype = 1, size = 2) +
    scale_y_continuous(limits = c(0, max(overall_state_admissions_defaulters()[["Default"]]))) +
    labs(title = paste("Defaulters over time - 2016 to 2019 - ", input$state_name, " State", sep = ""), 
                       x = "")

  if(input$smooth) {
    z <- z +
      geom_line(mapping = aes(y = `Defaulters (smoothed)`), 
                colour = "red", alpha = 0.5, linetype = 2, size = 2)
  }
  
  z <- z + 
    unicef_theme +
    theme(axis.text.x = element_text(size = 8, angle = 90),
          axis.text.y = element_text(size = 8))
  
  ggplotly(p = z)
})

plotlyOutput(outputId = "overall_state_defaulters")
```

### Defaulters - Locality

```{r, fig.height = 5}
output$overall_locality_defaulters <- renderPlotly({
  z <- overall_locality_admissions_defaulters() %>%
    ggplot(mapping = aes(x = MonthYear, group = 1)) +
    geom_line(mapping = aes(y = Default), 
              colour = "red", linetype = 1, size = 2) +
    scale_y_continuous(limits = c(0, max(overall_locality_admissions_defaulters()[["Default"]]))) +
    labs(title = paste("Defaulters over time - 2016 to 2019 - ",
                       input$locality_name, " Locality, ",
                       input$state_name, " State", sep = ""), 
                       x = "")

  if(input$smooth) {
    z <- z +
      geom_line(mapping = aes(y = `Defaulters (smoothed)`), 
                colour = "red", alpha = 0.5, linetype = 2, size = 2)
  }
  
  z <- z + 
    unicef_theme +
    theme(axis.text.x = element_text(size = 8, angle = 90),
          axis.text.y = element_text(size = 8))
  
  ggplotly(p = z)
})

plotlyOutput(outputId = "overall_locality_defaulters")
```

Row
--------------------------------------------------------------------------------

### Seasonal Calendar

```{r, fig.height = 1}
output$calendar <- renderPlot({
  seasonal_calendar %>%
    mutate(start = as.Date(start),
           end = as.Date(end),
           color = ifelse(is.na(event), NA,
                     ifelse(group == "Planting", "#324D12",
                       ifelse(group == "Rainfall", "#89CFF0", "#B22222"))),
           fontcolor = "white") %>%
    filter(year(start) == input$chosen_year) %>%
    gg_vistime() +
    #scale_x_date(breaks = seq.Date(from = as.Date(paste(input$chosen_year, "-01-01", sep = "")),
    #                               to = as.Date(paste(input$chosen_year, "-12-31", sep = "")),
    #                               by = "month"),
    #             limits = c(as.Date(paste(input$chosen_year, "-01-01", sep = "")),
    #                        as.Date(paste(input$chosen_year, "-12-31", sep = "")))) +
    unicef_theme
})

plotOutput(outputId = "calendar")
```

Row {.tabset .tabset-fade}
--------------------------------------------------------------------------------

### Admissions - National

```{r, fig.height = 8}
admissions_defaulters <- reactive({
  aggregate(cbind(`New Admissions`, Default) ~ Month + Year, 
            data = monitoring, FUN = sum) %>% 
    filter(Year == input$chosen_year) %>%
    mutate(Month = factor(x = Month, 
                          levels = c("Jan", "Feb", "Mar", "Apr", "May", "Jun", 
                                     "Jul", "Aug", "Sep", "Oct", "Nov", "Dec"))) %>%
    arrange(Month) %>%
    mutate(`Admissions (smoothed)` = smooth_m3a3(x = `New Admissions`),
           `Defaulters (smoothed)` = smooth_m3a3(x = Default))
})

output$admissions <- renderPlotly({
  z <- admissions_defaulters() %>%
    ggplot(mapping = aes(x = Month, group = Year)) +
    geom_line(mapping = aes(y = `New Admissions`), 
              colour = "blue", linetype = 1, size = 2) +
    scale_y_continuous(limits = c(0, max(admissions_defaulters()[["New Admissions"]])),
                       breaks = seq(from = 0, 
                                    to = max(admissions_defaulters()[["New Admissions"]]),
                                    by = 5000)) +
    labs(title = paste("Admissions over time - Year ", input$chosen_year, sep = ""),
         x = "")

  if(input$smooth) {
    z <- z +
      geom_line(mapping = aes(y = `Admissions (smoothed)`), 
                colour = "blue", alpha = 0.5, linetype = 2, size = 2)
  }
  
  z <- z + unicef_theme
  
  ggplotly(p = z)
})

plotlyOutput(outputId = "admissions")
```

### Admissions - State

```{r, fig.height = 8}
state_admissions_defaulters <- reactive({
  aggregate(cbind(`New Admissions`, Default) ~ State + Month + Year, 
            data = monitoring, FUN = sum) %>% 
    filter(Year == input$chosen_year) %>%
    mutate(Month = factor(x = Month, 
                          levels = c("Jan", "Feb", "Mar", "Apr", "May", "Jun", 
                                     "Jul", "Aug", "Sep", "Oct", "Nov", "Dec"))) %>%
    group_by(State) %>%
    arrange(Month, .by_group = TRUE) %>%
    mutate(`Admissions (smoothed)` = smooth_m3a3(x = `New Admissions`),
           `Defaulters (smoothed)` = smooth_m3a3(x = Default))
})

output$state_admissions <- renderPlotly({
  z <- state_admissions_defaulters() %>%
    ggplot(mapping = aes(x = Month, group = State)) +
    geom_line(mapping = aes(y = `New Admissions`), colour = "blue", size = 1) +
    labs(title = paste("Admissions over time by state - Year ", input$chosen_year, sep = ""),
         x = "") +
    facet_wrap( ~ State, ncol = 6, scales = input$scales)
      
  if(input$smooth) {
    z <- z +
      geom_line(mapping = aes(y = `Admissions (smoothed)`), 
                colour = "blue", alpha = 0.5, linetype = 2, size = 1)
  }

  if(input$scales == "fixed") {
   z <- z +
    scale_y_continuous(limits = c(0, max(state_admissions_defaulters()[["New Admissions"]])),
                       breaks = seq(from = 0, 
                                    to = max(state_admissions_defaulters()[["New Admissions"]]),
                                    by = 1000))
  }
  
  z <- z +
    unicef_theme +
    theme(axis.text.x = element_text(size = 8, angle = 90),
          axis.text.y = element_text(size = 8))
  
  ggplotly(p = z)
})

plotlyOutput(outputId = "state_admissions")
```

### Admissions - Locality

```{r, fig.height = 8}
locality_admissions_defaulters <- reactive({
  monitoring %>% 
    filter(Year == input$chosen_year,
           State == input$state_name) %>%
    mutate(Month = factor(x = Month, 
                          levels = c("Jan", "Feb", "Mar", "Apr", "May", "Jun", 
                                     "Jul", "Aug", "Sep", "Oct", "Nov", "Dec"))) %>%
    group_by(Locality) %>%
    arrange(Month, .by_group = TRUE) %>%
    mutate(`Admissions (smoothed)` = smooth_m3a3(x = `New Admissions`),
           `Defaulters (smoothed)` = smooth_m3a3(x = Default))
})

output$locality_admissions <- renderPlotly({
  z <- locality_admissions_defaulters() %>%
    ggplot(mapping = aes(x = Month, group = State)) +
    geom_line(mapping = aes(y = `New Admissions`), 
              colour = "blue", linetype = 1, size = 1) +
    labs(title = paste("Admissions over time in ", input$state_name, 
                       " State by locality - Year ", input$chosen_year, sep = ""),
         x = "") +
    facet_wrap( ~ Locality, nrow = 3, scale = input$scales)
  
  if(input$smooth) {
    z <- z
      geom_line(mapping = aes(y = `Admissions (smoothed)`), 
                colour = "blue", alpha = 0.5, linetype = 2, size = 1)
  }
  
  z <- z +
    unicef_theme +
    theme(axis.text.x = element_text(size = 8, angle = 90),
          axis.text.y = element_text(size = 8))
  
  ggplotly(p = z)
})

plotlyOutput(outputId = "locality_admissions")
```

Row {.tabset .tabset-fade}
--------------------------------------------------------------------------------

### Defaulters - National

```{r}
output$defaulters <- renderPlotly({
  z <- admissions_defaulters() %>%
    ggplot(mapping = aes(x = Month, group = Year)) +
    geom_line(mapping = aes(y = `Default`), colour = "red",
              linetype = 1, size = 2) +
    scale_y_continuous(limits = c(0, max(admissions_defaulters()[["Default"]])),
                       breaks = seq(from = 0, 
                                    to = max(admissions_defaulters()[["Default"]]),
                                    by = 500)) +
    labs(title = paste("Defaulters over time - Year ", input$chosen_year, sep = ""),
         x = "")
  
  if(input$smooth) {
    z <- z +
      geom_line(mapping = aes(y = `Defaulters (smoothed)`), 
                colour = "red", alpha = 0.5, linetype = 2, size = 2)
  }
  
  z <- z +
    unicef_theme
  
  ggplotly(p = z)
})

plotlyOutput(outputId = "defaulters")
```

### Defaulters - State

```{r, fig.height = 8}
output$state_defaulters <- renderPlotly({
  z <- state_admissions_defaulters() %>%
    ggplot(mapping = aes(x = Month, group = State)) +
    geom_line(mapping = aes(y = Default), colour = "red", 
              linetype = 1, size = 1) +    
    labs(title = paste("Defaulters over time by state - Year ", input$chosen_year, sep = ""),
         x = "") +
    facet_wrap( ~ State, ncol = 6, scale = input$scales)  
  
  if(input$smooth) {
    z <- z +
    geom_line(mapping = aes(y = `Defaulters (smoothed)`), 
              colour = "red", alpha = 0.5, linetype = 2, size = 1)
  }
  
  if(input$scales == "fixed") {
    z <- z +
    scale_y_continuous(limits = c(0, max(state_admissions_defaulters()[["Default"]])),
                       breaks = seq(from = 0, 
                                    to = max(state_admissions_defaulters()[["Default"]]),
                                    by = 100))
  }
  
  z <- z +
    unicef_theme +
    theme(axis.text.x = element_text(size = 8, angle = 90),
          axis.text.y = element_text(size = 8))
  
  ggplotly(p = z)
})

plotlyOutput(outputId = "state_defaulters")
```

### Defaulters - Locality

```{r, fig.height = 8}
output$locality_defaulters <- renderPlotly({
  z <- locality_admissions_defaulters() %>%
    ggplot(mapping = aes(x = Month, group = State)) +
    geom_line(mapping = aes(y = Default), 
              colour = "red", linetype = 1, size = 1) +
    labs(title = paste("Defaulters over time in ", input$state_name,
                       " State by locality - Year ", input$chosen_year, sep = ""),
         x = "") +
    facet_wrap( ~ Locality, nrow = 3, scale = input$scales)  
  
  if(input$smooth) {
      z <- z +
        geom_line(mapping = aes(y = `Defaulters (smoothed)`), 
                  colour = "red", alpha = 0.5, linetype = 2, size = 1)
  }
  
  z <- z +
    unicef_theme +
    theme(axis.text.x = element_text(size = 8, angle = 90),
          axis.text.y = element_text(size = 8))
  
  ggplotly(p = z)
})

plotlyOutput(outputId = "locality_defaulters")
```

<!---
Case-finding
================================================================================
--->
